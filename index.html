<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>September Transport Billing System</title>
    <style>
        /* All existing styles remain the same */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
        
        .main-content {
            flex: 1;
        }
        
        .dashboard-sidebar {
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .form-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
        
        button {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 25px;
        }
        
        button:hover {
            background-color: #1565c0;
        }
        
        .btn-secondary {
            background-color: #4caf50;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #388e3c;
        }
        
        .btn-print {
            background-color: #ff9800;
            margin-left: 10px;
        }
        
        .btn-print:hover {
            background-color: #f57c00;
        }
        
        .btn-download {
            background-color: #9c27b0;
            margin-left: 10px;
        }
        
        .btn-download:hover {
            background-color: #7b1fa2;
        }
        
        .results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
        
        .results-header {
            background-color: #1e88e5;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .results-content {
            padding: 25px;
        }
        
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .result-title {
            font-weight: 600;
            color: #1e88e5;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .add-vendor-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            display: none;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-field {
            flex: 1;
            min-width: 250px;
        }
        
        .vehicle-numbers-container {
            margin-top: 15px;
        }
        
        .vehicle-number-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .remove-vehicle {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-vehicle {
            background-color: #9e9e9e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Search suggestions styling */
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .highlight {
            background-color: #e3f2fd;
            font-weight: bold;
        }
        
        /* Transport details table */
        .transport-details {
            margin-top: 30px;
        }
        
        .transport-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .transport-table th, .transport-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .transport-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .transport-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* NEW: Summary box styles */
        .summary-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
        }
        
        .summary-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .summary-value {
            font-size: 24px;
            color: #1b5e20;
            font-weight: 700;
        }
        
        .summary-divider {
            width: 2px;
            height: 50px;
            background-color: #4caf50;
            margin: 0 20px;
        }
        
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e88e5;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        
        .saved-results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            padding: 25px;
        }
        
        .saved-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .saved-results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .saved-results-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
        }
        
        .saved-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .saved-result-item:last-child {
            border-bottom: none;
        }
        
        .saved-result-info {
            flex: 1;
        }
        
        .saved-result-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-remove {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-view {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* New styles for vendor grouping */
        .vendor-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .vendor-header {
            background-color: #e3f2fd;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .vendor-vehicles {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .vendor-vehicles.expanded {
            max-height: 500px;
            padding: 15px 20px;
        }
        
        .vehicle-option {
            padding: 10px 15px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .vehicle-option:hover {
            background-color: #f5f5f5;
        }
        
        .vehicle-option.selected {
            background-color: #e3f2fd;
            border-color: #1e88e5;
        }
        
        .amount-edit {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .amount-input {
            width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn-update {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .vehicle-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        
        /* NEW: Dashboard sidebar styles */
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e88e5;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .dashboard-section {
            margin-bottom: 25px;
        }
        
        .dashboard-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .dashboard-summary-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .dashboard-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .dashboard-summary-item:last-child {
            margin-bottom: 0;
        }
        
        .dashboard-label {
            font-weight: 500;
            color: #555;
        }
        
        .dashboard-value {
            font-weight: 600;
            color: #1e88e5;
        }
        
        .dashboard-highlight {
            font-weight: 700;
            color: #1565c0;
            font-size: 1.1rem;
        }
        
        .product-breakdown {
            margin-top: 15px;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        
        .product-name {
            font-weight: 500;
        }
        
        .product-qty {
            font-weight: 600;
            color: #2e7d32;
        }
        
        .product-amount {
            font-weight: 600;
            color: #d32f2f;
        }
        
        .dashboard-refresh {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .dashboard-refresh:hover {
            background-color: #1565c0;
        }
        
        .dashboard-loading {
            text-align: center;
            padding: 10px;
            color: #1e88e5;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .dashboard-sidebar {
                width: 100%;
                order: -1;
                margin-bottom: 20px;
            }
            
            .form-group, .form-field {
                min-width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .transport-table {
                display: block;
                overflow-x: auto;
            }
            
            .saved-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .saved-result-actions {
                width: 100%;
                justify-content: flex-end;
            }
            
            .amount-edit {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .amount-input {
                width: 100%;
            }
            
            /* NEW: Responsive styles for summary box */
            .summary-box {
                flex-direction: column;
                gap: 15px;
            }
            
            .summary-divider {
                width: 100%;
                height: 2px;
                margin: 10px 0;
            }
        }
        
        @media print {
            .search-section, .add-vendor-section, .btn-print, .saved-results-section, .dashboard-sidebar {
                display: none;
            }
            
            .results-section {
                display: block !important;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header>
                <h1>September Transport Billing System</h1>
            </header>
            
            <section class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="vehicleSearch">Search Vehicle Number:</label>
                        <input type="text" id="vehicleSearch" placeholder="Start typing vehicle number (e.g., AP39UJ)" autocomplete="off">
                        <div class="suggestions-container" id="suggestionsContainer"></div>
                    </div>
                </div>
                
                <button type="button" onclick="searchVehicle()">Search Vehicle</button>
                <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Add New Vendor</button>
                <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
            </section>
            
            <section class="results-section" id="resultsSection">
                <div class="results-header">
                    <span>Vehicle Details</span>
                    <div>
                        <button type="button" class="btn-secondary" onclick="saveCurrentResult()">Save to List</button>
                        <button type="button" class="btn-print" onclick="printResults()">Print</button>
                    </div>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be displayed here -->
                </div>
            </section>
            
            <section class="add-vendor-section" id="addVendorSection">
                <div class="results-header">Add New Vendor</div>
                <div class="results-content">
                    <form id="vendorForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="partyName">Party Name:</label>
                                <input type="text" id="partyName" required>
                            </div>
                            <div class="form-field">
                                <label for="accountNo">Account Number:</label>
                                <input type="text" id="accountNo" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="bankName">Bank Name & Branch:</label>
                                <input type="text" id="bankName" required>
                            </div>
                            <div class="form-field">
                                <label for="beneficiary">Beneficiary:</label>
                                <input type="text" id="beneficiary" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pan">PAN Number:</label>
                                <input type="text" id="pan" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>Vehicle Numbers:</label>
                                <div class="vehicle-numbers-container" id="vehicleNumbersContainer">
                                    <div class="vehicle-number-input">
                                        <input type="text" class="vehicleNumber" placeholder="Vehicle Number" required>
                                        <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>
                                    </div>
                                </div>
                                <button type="button" class="add-vehicle" onclick="addVehicleField()">Add Another Vehicle</button>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button type="button" onclick="addNewVendor()">Save Vendor</button>
                            <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </section>
            
            <section class="saved-results-section" id="savedResultsSection">
                <div class="saved-results-header">
                    <div class="saved-results-title">Saved Results</div>
                    <div>
                        <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
                        <button type="button" class="btn-secondary" onclick="clearSavedResults()">Clear All</button>
                    </div>
                </div>
                <div class="saved-results-list" id="savedResultsList">
                    <!-- Saved results will be displayed here -->
                </div>
            </section>
        </div>
        
        <!-- NEW: Dashboard Sidebar -->
        <div class="dashboard-sidebar">
            <div class="dashboard-title">Monthly Dashboard</div>
            
            <div class="dashboard-section">
                <div class="dashboard-section-title">Overall Summary</div>
                <div class="dashboard-summary-box">
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Vehicles:</span>
                        <span class="dashboard-value" id="totalVehicles">0</span>
                    </div>
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Records:</span>
                        <span class="dashboard-value" id="totalRecords">0</span>
                    </div>
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Quantity:</span>
                        <span class="dashboard-value" id="totalQuantity">0.00</span>
                    </div>
                    <div class="dashboard-summary-item dashboard-highlight">
                        <span class="dashboard-label">Total Amount:</span>
                        <span class="dashboard-value" id="totalAmount">₹0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-section">
                <div class="dashboard-section-title">Product Breakdown</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="productBreakdown">
                        <div class="dashboard-loading">Loading product data...</div>
                    </div>
                </div>
            </div>
            
            
            <button type="button" class="dashboard-refresh" onclick="updateDashboard()">Refresh Dashboard</button>
        </div>
    </div>

    <script>
        // Complete vehicle data with all transporters and their vehicle numbers
        let vehicleData = [
            {
                partyName: "YARA GOVIND RAO  - BT -2 ( Balaji  Transport )",
                accountNo: "29611100003742",
                bankName: "DCB Bank, Anakapalli",
                beneficiary: "YARA GOVIND RAO",
                pan: "AYBPY0969R",
                vehicleNumbers: ["AP39UY3435"]
            },
            {
                partyName: "YERRA BHAGYA LAKSHMI - BT- 1",
                accountNo: "42084751220",
                bankName: "SBI, Ankapalli",
                beneficiary: "YERRA BHAGYA LAKSHMI",
                pan: "FRCPB8273A",
                vehicleNumbers: ["AP39UY3345"]
            },
            {
                partyName: "GADASALA SHIVA",
                accountNo: "1420155000065560",
                bankName: "KVB",
                beneficiary: "Gadasala Shiva",
                pan: "BTSPG7175G",
                vehicleNumbers: ["AP39WC2389", "AP39UQ2489"]
            },
            {
                partyName: "Sri Modamamba Transport",
                accountNo: "6086101003133",
                bankName: "CANARA BANK",
                beneficiary: "Ommi Madhu babu",
                pan: "ABEYO1294K",
                vehicleNumbers: ["AP39UZ3335"]
            },
            {
                partyName: "Sri Vijayalaxmi Transport",
                accountNo: "868457131",
                bankName: "Indian Bank,Anakapalle",
                beneficiary: "S K Santosh Kumar",
                pan: "CWUPS1379C",
                vehicleNumbers: ["AP39W4518"]
            },
            {
                partyName: "SRI MODHAMAMBA TRANSPORT",
                accountNo: "6546322059",
                bankName: "Indian Bank Anakapalle",
                beneficiary: "MONDEPU GOPI",
                pan: "GDAPM7595D",
                vehicleNumbers: ["AP39W5005", "AP39UJ5678"]
            },
            {
                partyName: "SRI VARDHAN TRANSPORT",
                accountNo: "6086101005682",
                bankName: "CB Anakapalle",
                beneficiary: "PRIYANKA NAGULAPALLI",
                pan: "CCOPN9093G",
                vehicleNumbers: ["AP39W3579"]
            },
            {
                partyName: "SHREE NOOKAMBICA LORRY TRANSPORT",
                accountNo: "30893220505",
                bankName: "SBI, Anakapalle",
                beneficiary: "P.N.K.A Ananda Rao",
                pan: "CHOPP3166M",
                vehicleNumbers: ["AP39UF3245", "AP05TH2345", "AP39UP9239", "AP39WC9149"]
            },
            {
                partyName: "LAKSHMI SRINIVASA TRANSPORT",
                accountNo: "053501505619",
                bankName: "ICICI, Anakapalle",
                beneficiary: "Gali Venkata Nukaraju",
                pan: "BQDPG9659K",
                vehicleNumbers: ["AP39W0505", "AP39WC7499"]
            },
            {
                partyName: "SRI MODAMAMBA LORRY TRANSPORT -POLNATI RAMU",
                accountNo: "039301000039226",
                bankName: "Indian Overseas Bank-Anakapalli",
                beneficiary: "POLNATI RAMU",
                pan: "AMEPP6405E",
                vehicleNumbers: ["AP39TV2536", "AP39WB2536", "AP39WD2536"]
            },
            {
                partyName: "POLNATI LAKSHMANA",
                accountNo: "20393866584",
                bankName: "SBI, Anakapalle",
                beneficiary: "POLNATI LAKSHMANA",
                pan: "EHGPP6721J",
                vehicleNumbers: ["AP39TV2537"]
            },
            {
                partyName: "GADASALA VENKATA RAO",
                accountNo: "41897007408",
                bankName: "SBI, Anakapalle",
                beneficiary: "GADASALA VENKATA RAO",
                pan: "BNLPG8819G",
                vehicleNumbers: ["AP39UJ2489", "AP39UZ2489"]
            },
            {
                partyName: "Sri Durga Devi Lorry Services",
                accountNo: "30758927213",
                bankName: "SBI, Anakapalle",
                beneficiary: "N.Narisinga Rao",
                pan: "APCPN4125N",
                vehicleNumbers: ["AP39VE2979"]
            },
            {
                partyName: "Sri Balaji Transport",
                accountNo: "20286779205",
                bankName: "SBI",
                beneficiary: "Gangiredla Srinivasa Rao",
                pan: "BZJPG9951K",
                vehicleNumbers: ["AP39UE5163", "AP39VB2727", "AP39UP4799"]
            },
            {
                partyName: "BINDHU SREE TRANSPORT AND CONSTRUCTIONS",
                accountNo: "053505500548",
                bankName: "ICICI, Anakapalle",
                beneficiary: "NAMMI SUNITHA",
                pan: "BMHPB1489C",
                vehicleNumbers: ["AP39VC5289", "AP39UW2589"]
            },
            {
                partyName: "Sri Venkata Durga Lorry service",
                accountNo: "50100398807876",
                bankName: "HDFC, Anakapalle",
                beneficiary: "Ullingala Nageswar Rao",
                pan: "CKQPN5200B",
                vehicleNumbers: ["AP39TN2579", "AP39UJ2669"]
            },
            {
                partyName: "Mummina Srinu",
                accountNo: "31897791454",
                bankName: "SBI",
                beneficiary: "Mummina Srinu",
                pan: "NIEPS1843A",
                vehicleNumbers: ["AP39UZ3659"]
            },
            {
                partyName: "SRI  MODAMAMBA LORRY TRANSPORT",
                accountNo: "386602010025075",
                bankName: "UNION BANK",
                beneficiary: "Lanka Nageswara Rao",
                pan: "AYWPL8780A",
                vehicleNumbers: ["AP39UU5665"]
            },
            {
                partyName: "R.K TRANSPORT",
                accountNo: "18862612000462",
                bankName: "PUNJAB NATIONAL BANK",
                beneficiary: "Ommi Venkata Rao",
                pan: "CACPV1217L",
                vehicleNumbers: ["AP39UG0559"]
            },
            {
                partyName: "SRI SIVA DURGA LORRY SERVICE",
                accountNo: "44005352428",
                bankName: "SBI, ANAKAPALLI",
                beneficiary: "Kommuri Durga Prasad",
                pan: "CKBPK7332L",
                vehicleNumbers: ["AP39WD8349"]
            },
            {
                partyName: "SRI MANIKANTA BALAJI LORRY TRANSPORT",
                accountNo: "33982901231",
                bankName: "SBI, Anakapalle",
                beneficiary: "M SOMUNAIDU",
                pan: "CLXPM8882N",
                vehicleNumbers: ["AP39WD4199"]
            },
            {
                partyName: "Sri Kanaka Durga LorrySERVICE",
                accountNo: "50100482507472",
                bankName: "HDFC, Anakapalle",
                beneficiary: "CH.POLANDRA",
                pan: "FRQPP2042K",
                vehicleNumbers: ["AP39UJ2399"]
            },
            {
                partyName: "K DURGA RAO",
                accountNo: "184010100508162",
                bankName: "AXIS BANK OF INDIA ANAKAPALLE",
                beneficiary: "K.DURGA RAO",
                pan: "BCBPR6347H",
                vehicleNumbers: ["AP31TN4302", "AP39VB8829"]
            },
            {
                partyName: "SIRI BUILDTECH",
                accountNo: "10230601834",
                bankName: "IDFC FIRST BANK",
                beneficiary: "Kondala Rao",
                pan: "CCAPK6960M",
                vehicleNumbers: ["AP39WH 3659"]
            },
            {
                partyName: "DURGALAMMATALLI LORRY SERVICE",
                accountNo: "32949321587",
                bankName: "SBI ANAKAPALLE",
                beneficiary: "DASARI GOVINDA",
                pan: "CMJPD4773Q",
                vehicleNumbers: ["AP39WE9299", "AP39UM4767"]
            },
            {
                partyName: "SREE MODHAMAMBHA TRANSPORT",
                accountNo: "386602010026387",
                bankName: "UNION BANK",
                beneficiary: "B HEMANTH KUMAR",
                pan: "CEGPB5646M",
                vehicleNumbers: ["AP39WH2769", "AP39WH1869"]
            },
            {
                partyName: "SRI PYDIMAMBA LORRY SERVICES",
                accountNo: "39080100013298",
                bankName: "BANK OF BARODA",
                beneficiary: "LOKIREDDI NAGABABU",
                pan: "CNZPN5078D",
                vehicleNumbers: ["AP39UV2345", "AP39UN3335", "AP39WE2345", "AP39VD5226", "AP39TU2489", "AP39WE3339", "AP39UD2345", "AP39UZ2345", "AP39W7119"]
            },
            {
                partyName: "Sri Kanaka Durga Lorry transprot",
                accountNo: "3512984417",
                bankName: "Kotak Mahindra Anakapalli",
                beneficiary: "Karanam Uma Maheswara Rao",
                pan: "IBOPK6921H",
                vehicleNumbers: ["AP39UJ1166", "AP39W2399"]
            },
            {
                partyName: "SRI BALA DURGA LORRY SERVICE",
                accountNo: "36055252391",
                bankName: "SBI, Anakapalle",
                beneficiary: "J.SRI PADHAVALLAABHA",
                pan: "CCEPJ2049G",
                vehicleNumbers: ["AP39VF2339"]
            },
            {
                partyName: "SRI MODA VENKATA SURYA LORRY SERVICE",
                accountNo: "33808097568",
                bankName: "ANAKAPALLE",
                beneficiary: "POLNATI TATA RAO",
                pan: "BYEPP6263R",
                vehicleNumbers: ["AP39UC6939"]
            },
            {
                partyName: "POLNATI ANNAPURNA",
                accountNo: "6086101003959",
                bankName: "CANARA BANK",
                beneficiary: "Polnati Annapuran",
                pan: "DWOPP2749J",
                vehicleNumbers: ["AP39WC9149", "AP39UP9239"]
            },
            {
                partyName: "SRI VIJAYA DURGA ENTERPRISES",
                accountNo: "31499967751",
                bankName: "SBI ANAKAPALLE",
                beneficiary: "VASADI RAMESH",
                pan: "AGNPV7563J",
                vehicleNumbers: []
            },
            {
                partyName: "Sri Polnati Venkata Srinivas Rao",
                accountNo: "11040675260",
                bankName: "SBI, Anakapalle",
                beneficiary: "Polnati Venkata Srinivasrao",
                pan: "EMOPP4189M",
                vehicleNumbers: ["AP39UH2489"]
            }
        ];

        // Transport data
        let transportData = [];
        
        // Saved results
        let savedResults = [];

        // Initialize the application
        function initApp() {
            setupSearchFunctionality();
            loadTransportData();
            loadSavedResults();
        }

        // Load transport data from GitHub
        async function loadTransportData() {
            try {
                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '<div class="loading">Loading transport data...</div>';
                
                // GitHub raw URL for the Excel file
                const githubUrl = 'https://raw.githubusercontent.com/bimal-bp/SEP_TRANSPORT_BILL/main/SEP_trans_bill.xlsx';
                
                // Fetch the Excel file
                const response = await fetch(githubUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status}`);
                }
                
                // Convert to blob
                const blob = await response.blob();
                
                // Read the Excel file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // Parse the Excel file
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Get the first sheet
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        
                        // Convert to JSON with date handling
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            raw: false,
                            dateNF: 'yyyy-mm-dd' // Specify date format
                        });
                        
                        // Process the data
                        processTransportData(jsonData, worksheet);
                        
                        // Clear loading message
                        resultsContent.innerHTML = '';
                        
                        // Update dashboard
                        updateDashboard();
                    } catch (error) {
                        console.error('Error processing Excel data:', error);
                        resultsContent.innerHTML = '<div class="no-results">Error loading transport data. Please try again later.</div>';
                    }
                };
                
                reader.readAsArrayBuffer(blob);
            } catch (error) {
                console.error('Error fetching transport data:', error);
                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '<div class="no-results">Error loading transport data. Please try again later.</div>';
            }
        }

        // Process transport data
        function processTransportData(jsonData, worksheet) {
            if (!jsonData || jsonData.length < 2) {
                console.error('Invalid data format');
                return;
            }
            
            // Extract headers (first row)
            const headers = jsonData[0].map(header => header ? header.toString().trim() : '');
            
            // Process data rows
            transportData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > 0) {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header && row[index] !== undefined) {
                            // Handle date conversion for Accounting Date column
                            if (header === 'Accounting Date' && row[index]) {
                                rowData[header] = convertExcelDate(row[index]);
                            } else {
                                rowData[header] = row[index];
                            }
                        }
                    });
                    transportData.push(rowData);
                }
            }
            
            console.log('Transport data loaded:', transportData.length, 'records');
        }

        // NEW: Update dashboard with summary data
        function updateDashboard() {
            if (transportData.length === 0) {
                document.getElementById('totalVehicles').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('totalQuantity').textContent = '0.00';
                document.getElementById('totalAmount').textContent = '₹0.00';
                document.getElementById('productBreakdown').innerHTML = '<div class="dashboard-loading">No data available</div>';
                document.getElementById('topVehicles').innerHTML = '<div class="dashboard-loading">No data available</div>';
                return;
            }
            
            // Calculate overall totals
            let totalVehicles = new Set();
            let totalRecords = transportData.length;
            let totalQuantity = 0;
            let totalAmount = 0;
            
            // Calculate product breakdown
            let productBreakdown = {};
            let vehicleBreakdown = {};
            
            transportData.forEach(record => {
                // Add vehicle to set
                const vehicleNo = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                if (vehicleNo) {
                    totalVehicles.add(vehicleNo);
                }
                
                // Calculate quantity
                const quantity = parseFloat(record['NET WT']) || 0;
                totalQuantity += quantity;
                
                // Calculate amount
                const amount = parseFloat(record['Transport Amount']) || 0;
                totalAmount += amount;
                
                // Product breakdown
                const material = record['Material'] ? record['Material'].toString().trim() : 'Unknown';
                if (!productBreakdown[material]) {
                    productBreakdown[material] = {
                        quantity: 0,
                        amount: 0
                    };
                }
                productBreakdown[material].quantity += quantity;
                productBreakdown[material].amount += amount;
                
                // Vehicle breakdown
                if (vehicleNo) {
                    if (!vehicleBreakdown[vehicleNo]) {
                        vehicleBreakdown[vehicleNo] = {
                            quantity: 0,
                            amount: 0,
                            records: 0
                        };
                    }
                    vehicleBreakdown[vehicleNo].quantity += quantity;
                    vehicleBreakdown[vehicleNo].amount += amount;
                    vehicleBreakdown[vehicleNo].records += 1;
                }
            });
            
            // Update overall summary
            document.getElementById('totalVehicles').textContent = totalVehicles.size;
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
            
            // Update product breakdown
            const productBreakdownElement = document.getElementById('productBreakdown');
            productBreakdownElement.innerHTML = '';
            
            // Sort products by quantity (descending)
            const sortedProducts = Object.entries(productBreakdown).sort((a, b) => b[1].quantity - a[1].quantity);
            
            sortedProducts.forEach(([product, data]) => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.innerHTML = `
                    <div class="product-name">${product}</div>
                    <div class="product-qty">${data.quantity.toFixed(2)}</div>
                    <div class="product-amount">₹${data.amount.toFixed(2)}</div>
                `;
                productBreakdownElement.appendChild(productItem);
            });
            
            // Update top vehicles
            const topVehiclesElement = document.getElementById('topVehicles');
            topVehiclesElement.innerHTML = '';
            
            // Sort vehicles by amount (descending) and take top 5
            const sortedVehicles = Object.entries(vehicleBreakdown).sort((a, b) => b[1].amount - a[1].amount).slice(0, 5);
            
            sortedVehicles.forEach(([vehicle, data]) => {
                const vehicleItem = document.createElement('div');
                vehicleItem.className = 'product-item';
                vehicleItem.innerHTML = `
                    <div class="product-name">${vehicle}</div>
                    <div class="product-qty">${data.quantity.toFixed(2)}</div>
                    <div class="product-amount">₹${data.amount.toFixed(2)}</div>
                `;
                topVehiclesElement.appendChild(vehicleItem);
            });
        }

        // Convert Excel serial date to JavaScript Date object
        function convertExcelDate(excelDate) {
            // If it's already a proper date string, return it
            if (typeof excelDate === 'string' && excelDate.includes('-')) {
                return excelDate;
            }
            
            // If it's a number (Excel serial date), convert it
            if (typeof excelDate === 'number') {
                // Excel date serial numbers start from January 1, 1900
                const excelEpoch = new Date(1900, 0, 1);
                // Subtract 2 days because Excel incorrectly considers 1900 as a leap year
                const jsDate = new Date(excelEpoch.getTime() + (excelDate - 2) * 24 * 60 * 60 * 1000);
                return jsDate.toISOString().split('T')[0]; // Return as YYYY-MM-DD
            }
            
            // If it's already a Date object, format it
            if (excelDate instanceof Date) {
                return excelDate.toISOString().split('T')[0];
            }
            
            // Return as is if we can't convert it
            return excelDate;
        }

        // Format date for display
        function formatDateForDisplay(dateValue) {
            if (!dateValue) return '';
            
            // If it's already a formatted date string, return it
            if (typeof dateValue === 'string' && dateValue.includes('-')) {
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString('en-IN'); // Indian date format
                }
                return dateValue;
            }
            
            // If it's a Date object
            if (dateValue instanceof Date) {
                return dateValue.toLocaleDateString('en-IN');
            }
            
            // Return as is if we can't format it
            return dateValue;
        }

        // Set up search functionality
        function setupSearchFunctionality() {
            const searchInput = document.getElementById('vehicleSearch');
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            
            // Event listener for input changes
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toUpperCase();
                
                // Clear suggestions if search term is empty
                if (searchTerm.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                
                // Get matching vehicle numbers from both vehicleData and transportData
                const matches = getMatchingVehicles(searchTerm);
                
                // Display suggestions
                displaySuggestions(matches, searchTerm);
            });
            
            // Event listener for clicks outside the search area
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // Event listener for keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
                const activeSuggestion = suggestionsContainer.querySelector('.suggestion-item.active');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (suggestions.length > 0) {
                        if (!activeSuggestion) {
                            suggestions[0].classList.add('active');
                        } else {
                            const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                            const nextIndex = (currentIndex + 1) % suggestions.length;
                            activeSuggestion.classList.remove('active');
                            suggestions[nextIndex].classList.add('active');
                        }
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (suggestions.length > 0 && activeSuggestion) {
                        const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                        const prevIndex = (currentIndex - 1 + suggestions.length) % suggestions.length;
                        activeSuggestion.classList.remove('active');
                        suggestions[prevIndex].classList.add('active');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestion) {
                        searchInput.value = activeSuggestion.textContent;
                        suggestionsContainer.style.display = 'none';
                        searchVehicle();
                    } else {
                        searchVehicle();
                    }
                }
            });
        }

        // Get matching vehicles based on search term
        function getMatchingVehicles(searchTerm) {
            const matches = [];
            
            // Get matches from vehicleData
            vehicleData.forEach(vehicle => {
                vehicle.vehicleNumbers.forEach(number => {
                    if (number && number.includes(searchTerm) && !matches.includes(number)) {
                        matches.push(number);
                    }
                });
            });
            
            // Get matches from transportData (vehicles that have transactions but no vendor details)
            if (transportData.length > 0) {
                transportData.forEach(record => {
                    const vehicleNo = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                    if (vehicleNo && vehicleNo.includes(searchTerm) && !matches.includes(vehicleNo)) {
                        matches.push(vehicleNo);
                    }
                });
            }
            
            // Sort matches by relevance (closer matches first)
            matches.sort((a, b) => {
                const aIndex = a.indexOf(searchTerm);
                const bIndex = b.indexOf(searchTerm);
                return aIndex - bIndex;
            });
            
            return matches;
        }

        // Display suggestions in the dropdown
        function displaySuggestions(matches, searchTerm) {
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            
            // Clear previous suggestions
            suggestionsContainer.innerHTML = '';
            
            if (matches.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            // Create suggestion items
            matches.forEach(match => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                suggestionItem.textContent = match;
                
                // Highlight the matching part
                const regex = new RegExp(searchTerm, 'gi');
                suggestionItem.innerHTML = match.replace(regex, '<span class="highlight">$&</span>');
                
                // Add click event
                suggestionItem.addEventListener('click', function() {
                    document.getElementById('vehicleSearch').value = match;
                    suggestionsContainer.style.display = 'none';
                    searchVehicle();
                });
                
                // Add hover effect
                suggestionItem.addEventListener('mouseover', function() {
                    // Remove active class from all suggestions
                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    // Add active class to current suggestion
                    this.classList.add('active');
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            suggestionsContainer.style.display = 'block';
        }

        // Search function
        function searchVehicle() {
            const searchValue = document.getElementById('vehicleSearch').value.trim().toUpperCase();
            
            if (!searchValue) {
                alert('Please enter a vehicle number');
                return;
            }
            
            const results = vehicleData.filter(vehicle => 
                vehicle.vehicleNumbers.includes(searchValue)
            );
            
            displayResults(results, searchValue);
        }

        // Display results
        function displayResults(results, searchValue) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsContent.innerHTML = '';
            
            // Store current search details for saving
            window.currentSearch = {
                vehicleNumber: searchValue,
                vendorDetails: results,
                transportRecords: []
            };
            
            // Check if vehicle has transport records
            const transportRecords = transportData.filter(record => {
                const recordVehicleNo = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                return recordVehicleNo === searchValue;
            });
            
            window.currentSearch.transportRecords = transportRecords;
            
            if (results.length === 0) {
                if (transportRecords.length > 0) {
                    // Vehicle has transport records but no vendor details
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'warning';
                    warningDiv.innerHTML = `
                        <strong>Note:</strong> Vendor details not found for vehicle number: ${searchValue}. 
                        However, transport records are available below.
                    `;
                    resultsContent.appendChild(warningDiv);
                    
                    // Display transport details
                    displayTransportDetails(searchValue, transportRecords);
                } else {
                    // No vendor details and no transport records
                    resultsContent.innerHTML = '<div class="no-results">No vendor details found for vehicle number: ' + searchValue + '</div>';
                }
            } else {
                // Group results by vendor
                const vendorGroups = {};
                
                results.forEach(vehicle => {
                    const vendorKey = vehicle.partyName + '|' + vehicle.pan;
                    if (!vendorGroups[vendorKey]) {
                        vendorGroups[vendorKey] = {
                            vendor: vehicle,
                            vehicles: []
                        };
                    }
                    
                    // Add all vehicles for this vendor
                    vehicle.vehicleNumbers.forEach(vehicleNumber => {
                        if (!vendorGroups[vendorKey].vehicles.includes(vehicleNumber)) {
                            vendorGroups[vendorKey].vehicles.push(vehicleNumber);
                        }
                    });
                });
                
                // Display vendor groups
                Object.values(vendorGroups).forEach((group, index) => {
                    const vendorGroupDiv = document.createElement('div');
                    vendorGroupDiv.className = 'vendor-group';
                    
                    const vendorHeader = document.createElement('div');
                    vendorHeader.className = 'vendor-header';
                    vendorHeader.innerHTML = `
                        <div>
                            <div class="result-title">${group.vendor.partyName}</div>
                            <div><strong>PAN:</strong> ${group.vendor.pan}</div>
                        </div>
                        <div>${group.vehicles.length} Vehicles</div>
                    `;
                    
                    const vendorVehicles = document.createElement('div');
                    vendorVehicles.className = 'vendor-vehicles';
                    vendorVehicles.id = `vendorVehicles${index}`;
                    
                    // Add vehicle options
                    group.vehicles.forEach(vehicleNumber => {
                        const vehicleOption = document.createElement('div');
                        vehicleOption.className = 'vehicle-option';
                        if (vehicleNumber === searchValue) {
                            vehicleOption.classList.add('selected');
                        }
                        vehicleOption.textContent = vehicleNumber;
                        vehicleOption.addEventListener('click', function() {
                            // Remove selected class from all options
                            vendorVehicles.querySelectorAll('.vehicle-option').forEach(option => {
                                option.classList.remove('selected');
                            });
                            // Add selected class to clicked option
                            this.classList.add('selected');
                            // Search for this vehicle
                            document.getElementById('vehicleSearch').value = vehicleNumber;
                            searchVehicle();
                        });
                        vendorVehicles.appendChild(vehicleOption);
                    });
                    
                    // Toggle vendor vehicles on header click
                    vendorHeader.addEventListener('click', function() {
                        vendorVehicles.classList.toggle('expanded');
                    });
                    
                    vendorGroupDiv.appendChild(vendorHeader);
                    vendorGroupDiv.appendChild(vendorVehicles);
                    resultsContent.appendChild(vendorGroupDiv);
                    
                    // Display vendor details
                    const vendorDetailsDiv = document.createElement('div');
                    vendorDetailsDiv.className = 'result-item';
                    vendorDetailsDiv.innerHTML = `
                        <div><strong>Bank Account No.:</strong> ${group.vendor.accountNo}</div>
                        <div><strong>Bank Name & Branch:</strong> ${group.vendor.bankName}</div>
                        <div><strong>Beneficiary:</strong> ${group.vendor.beneficiary}</div>
                    `;
                    resultsContent.appendChild(vendorDetailsDiv);
                });
                
                // Display transport details for the searched vehicle
                if (transportRecords.length > 0) {
                    displayTransportDetails(searchValue, transportRecords);
                } else {
                    // If we have vendor details but no transport records
                    const noTransportDiv = document.createElement('div');
                    noTransportDiv.className = 'no-results';
                    noTransportDiv.textContent = 'No transport records found for this vehicle.';
                    resultsContent.appendChild(noTransportDiv);
                }
            }
            
            resultsSection.style.display = 'block';
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Display transport details
        function displayTransportDetails(vehicleNumber, transportRecords) {
            if (transportRecords.length === 0) {
                return; // No transport records to display
            }
            
            // Create transport details section
            const transportDiv = document.createElement('div');
            transportDiv.className = 'transport-details';
            
            transportDiv.innerHTML = `
                <div class="result-title">Transport Details for Vehicle: ${vehicleNumber}</div>
                <table class="transport-table">
                    <thead>
                        <tr>
                            <th>Accounting Date</th>
                            <th>Customer Name</th>
                            <th>Vehicle No</th>
                            <th>Material</th>
                            <th>Net Weight</th>
                            <th>Transport Rate</th>
                            <th>Transport Amount</th>
                        </tr>
                    </thead>
                    <tbody id="transportTableBody">
                    </tbody>
                </table>
                <div class="summary-box" id="summaryBox">
                    <div class="summary-item">
                        <div class="summary-label">Total Records</div>
                        <div class="summary-value" id="totalRecords">0</div>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item">
                        <div class="summary-label">Total Quantity</div>
                        <div class="summary-value" id="totalQuantity">0</div>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-item">
                        <div class="summary-label">Total Amount</div>
                        <div class="summary-value" id="totalAmount">0.00</div>
                    </div>
                </div>
                <div class="amount-edit">
                    <label for="manualAmount">Manual Total Amount:</label>
                    <input type="number" id="manualAmount" class="amount-input" placeholder="Enter amount">
                    <button type="button" class="btn-update" onclick="updateTotalAmount()">Update Total</button>
                </div>
            `;
            
            document.getElementById('resultsContent').appendChild(transportDiv);
            
            // Populate table rows
            const tableBody = document.getElementById('transportTableBody');
            let totalAmount = 0;
            let totalQuantity = 0;
            
            transportRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // Format date properly
                const accountingDate = formatDateForDisplay(record['Accounting Date']);
                
                row.innerHTML = `
                    <td>${accountingDate}</td>
                    <td>${record['NAME OF THE CUSTOMER'] || ''}</td>
                    <td>${record['VEHICLE NO'] || ''}</td>
                    <td>${record['Material'] || ''}</td>
                    <td>${record['NET WT'] || ''}</td>
                    <td>${record['Transport Rate'] || ''}</td>
                    <td>${record['Transport Amount'] || ''}</td>
                `;
                
                tableBody.appendChild(row);
                
                // Calculate total amount
                const amount = parseFloat(record['Transport Amount']) || 0;
                totalAmount += amount;
                
                // Calculate total quantity
                const quantity = parseFloat(record['NET WT']) || 0;
                totalQuantity += quantity;
            });
            
            // Update summary box
            document.getElementById('totalRecords').textContent = transportRecords.length;
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);
            
            // Set manual amount input
            document.getElementById('manualAmount').value = totalAmount.toFixed(2);
            
            // Update current search with totals
            window.currentSearch.totalAmount = totalAmount;
            window.currentSearch.totalQuantity = totalQuantity;
            window.currentSearch.recordCount = transportRecords.length;
        }

        // Update total amount manually
        function updateTotalAmount() {
            const manualAmount = parseFloat(document.getElementById('manualAmount').value);
            
            if (isNaN(manualAmount)) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Update summary box
            document.getElementById('totalAmount').textContent = manualAmount.toFixed(2);
            
            // Update current search
            window.currentSearch.totalAmount = manualAmount;
            
            alert('Total amount updated successfully!');
        }

        // Save current result to the saved results list
        function saveCurrentResult() {
            if (!window.currentSearch) {
                alert('No search results to save');
                return;
            }
            
            const searchValue = window.currentSearch.vehicleNumber;
            
            // Check if this vehicle is already in saved results
            const existingIndex = savedResults.findIndex(result => result.vehicleNumber === searchValue);
            
            if (existingIndex !== -1) {
                // Update existing entry
                savedResults[existingIndex] = {...window.currentSearch};
            } else {
                // Add new entry with timestamp
                savedResults.push({
                    ...window.currentSearch,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Save to localStorage
            saveSavedResults();
            
            // Update the display
            displaySavedResults();
            
            alert('Result saved successfully!');
        }

        // Load saved results from localStorage
        function loadSavedResults() {
            const saved = localStorage.getItem('transportSavedResults');
            if (saved) {
                savedResults = JSON.parse(saved);
                displaySavedResults();
            }
        }

        // Save results to localStorage
        function saveSavedResults() {
            localStorage.setItem('transportSavedResults', JSON.stringify(savedResults));
        }

        // Display saved results
        function displaySavedResults() {
            const savedResultsList = document.getElementById('savedResultsList');
            
            if (savedResults.length === 0) {
                savedResultsList.innerHTML = '<div class="no-results">No saved results yet. Search for a vehicle and click "Save to List" to add it here.</div>';
                return;
            }
            
            savedResultsList.innerHTML = '';
            
            savedResults.forEach((result, index) => {
                const savedItem = document.createElement('div');
                savedItem.className = 'saved-result-item';
                
                const vendorName = result.vendorDetails.length > 0 
                    ? result.vendorDetails[0].partyName 
                    : 'Vendor details not found';
                
                const panNumber = result.vendorDetails.length > 0 
                    ? result.vendorDetails[0].pan 
                    : 'N/A';
                
                savedItem.innerHTML = `
                    <div class="saved-result-info">
                        <div class="result-title">${result.vehicleNumber}</div>
                        <div><strong>Vendor:</strong> ${vendorName}</div>
                        <div><strong>PAN:</strong> ${panNumber}</div>
                        <div><strong>Records:</strong> ${result.recordCount || 0} transactions</div>
                        <div><strong>Total Quantity:</strong> ${(result.totalQuantity || 0).toFixed(2)}</div>
                        <div><strong>Total Amount:</strong> ${(result.totalAmount || 0).toFixed(2)}</div>
                    </div>
                    <div class="saved-result-actions">
                        <button type="button" class="btn-view" onclick="viewSavedResult(${index})">View</button>
                        <button type="button" class="btn-remove" onclick="removeSavedResult(${index})">Remove</button>
                    </div>
                `;
                
                savedResultsList.appendChild(savedItem);
            });
        }

        // View a saved result
        function viewSavedResult(index) {
            if (index < 0 || index >= savedResults.length) return;
            
            const result = savedResults[index];
            
            // Set the search input
            document.getElementById('vehicleSearch').value = result.vehicleNumber;
            
            // Display the results
            displayResults(result.vendorDetails, result.vehicleNumber);
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Remove a saved result
        function removeSavedResult(index) {
            if (index < 0 || index >= savedResults.length) return;
            
            if (confirm('Are you sure you want to remove this saved result?')) {
                savedResults.splice(index, 1);
                saveSavedResults();
                displaySavedResults();
            }
        }

        // Clear all saved results
        function clearSavedResults() {
            if (savedResults.length === 0) {
                alert('No saved results to clear');
                return;
            }
            
            if (confirm('Are you sure you want to clear all saved results?')) {
                savedResults = [];
                saveSavedResults();
                displaySavedResults();
            }
        }

        // Download saved results as Excel file
        function downloadSavedResults() {
            if (savedResults.length === 0) {
                alert('No saved results to download');
                return;
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Prepare data for the summary sheet
            const summaryData = [
                ['Vehicle Number', 'Vendor Name', 'PAN', 'Account Number', 'Bank Name', 'Beneficiary', 'Total Records', 'Total Quantity', 'Total Amount']
            ];
            
            savedResults.forEach(result => {
                const vendor = result.vendorDetails.length > 0 ? result.vendorDetails[0] : null;
                
                summaryData.push([
                    result.vehicleNumber,
                    vendor ? vendor.partyName : 'Not Found',
                    vendor ? vendor.pan : 'N/A',
                    vendor ? vendor.accountNo : 'N/A',
                    vendor ? vendor.bankName : 'N/A',
                    vendor ? vendor.beneficiary : 'N/A',
                    result.recordCount || 0,
                    result.totalQuantity || 0,
                    result.totalAmount || 0
                ]);
            });
            
            // Create summary worksheet
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Create detailed worksheets for each saved result
            savedResults.forEach((result, index) => {
                if (result.transportRecords.length > 0) {
                    const detailData = [
                        ['Accounting Date', 'Customer Name', 'Vehicle No', 'Material', 'Net Weight', 'Transport Rate', 'Transport Amount']
                    ];
                    
                    result.transportRecords.forEach(record => {
                        detailData.push([
                            formatDateForDisplay(record['Accounting Date']),
                            record['NAME OF THE CUSTOMER'] || '',
                            record['VEHICLE NO'] || '',
                            record['Material'] || '',
                            record['NET WT'] || '',
                            record['Transport Rate'] || '',
                            record['Transport Amount'] || ''
                        ]);
                    });
                    
                    // Add summary row
                    detailData.push([]);
                    detailData.push(['Total Records:', result.recordCount || 0]);
                    detailData.push(['Total Quantity:', result.totalQuantity || 0]);
                    detailData.push(['Total Amount:', result.totalAmount || 0]);
                    
                    const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                    XLSX.utils.book_append_sheet(wb, detailWs, result.vehicleNumber);
                }
            });
            
            // Generate and download the file
            const fileName = `Transport_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Print results
        function printResults() {
            window.print();
        }

        // Toggle add vendor form
        function toggleAddVendorForm() {
            const addVendorSection = document.getElementById('addVendorSection');
            const resultsSection = document.getElementById('resultsSection');
            
            if (addVendorSection.style.display === 'block') {
                addVendorSection.style.display = 'none';
                document.getElementById('vendorForm').reset();
                // Reset to single vehicle field
                const container = document.getElementById('vehicleNumbersContainer');
                while (container.children.length > 1) {
                    container.removeChild(container.lastChild);
                }
            } else {
                addVendorSection.style.display = 'block';
                resultsSection.style.display = 'none';
                addVendorSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Add vehicle field
        function addVehicleField() {
            const container = document.getElementById('vehicleNumbersContainer');
            const newField = document.createElement('div');
            newField.className = 'vehicle-number-input';
            newField.innerHTML = `
                <input type="text" class="vehicleNumber" placeholder="Vehicle Number">
                <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>
            `;
            container.appendChild(newField);
        }

        // Remove vehicle field
        function removeVehicleField(button) {
            const container = document.getElementById('vehicleNumbersContainer');
            if (container.children.length > 1) {
                container.removeChild(button.parentNode);
            }
        }

        // Add new vendor
        function addNewVendor() {
            const partyName = document.getElementById('partyName').value.trim();
            const accountNo = document.getElementById('accountNo').value.trim();
            const bankName = document.getElementById('bankName').value.trim();
            const beneficiary = document.getElementById('beneficiary').value.trim();
            const pan = document.getElementById('pan').value.trim();
            
            // Get all vehicle numbers
            const vehicleInputs = document.querySelectorAll('.vehicleNumber');
            const vehicleNumbers = [];
            
            vehicleInputs.forEach(input => {
                const value = input.value.trim().toUpperCase();
                if (value) {
                    vehicleNumbers.push(value);
                }
            });
            
            // Validate required fields
            if (!partyName || !accountNo || !bankName || !beneficiary || !pan || vehicleNumbers.length === 0) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Create new vendor object
            const newVendor = {
                partyName,
                accountNo,
                bankName,
                beneficiary,
                pan,
                vehicleNumbers
            };
            
            // Add to data array
            vehicleData.push(newVendor);
            
            // Show success message
            alert('Vendor added successfully!');
            
            // Reset form and hide it
            document.getElementById('vendorForm').reset();
            toggleAddVendorForm();
        }

        // Initialize the app when page loads
        window.onload = initApp;
    </script>
    
    <!-- Include SheetJS library for Excel file processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
