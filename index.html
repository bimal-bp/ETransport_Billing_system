<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>October Transport Billing System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
     
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
     
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
     
        .main-content {
            flex: 1;
        }
     
        .dashboard-sidebar {
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
        }
     
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
     
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
     
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
     
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
     
        .form-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
     
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
     
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
     
        select:focus, input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
     
        button {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 25px;
        }
     
        button:hover {
            background-color: #1565c0;
        }
     
        .btn-secondary {
            background-color: #4caf50;
            margin-left: 10px;
        }
     
        .btn-secondary:hover {
            background-color: #388e3c;
        }
     
        .btn-print {
            background-color: #ff9800;
            margin-left: 10px;
        }
     
        .btn-print:hover {
            background-color: #f57c00;
        }
     
        .btn-download {
            background-color: #9c27b0;
            margin-left: 10px;
        }
     
        .btn-download:hover {
            background-color: #7b1fa2;
        }
     
        .results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
     
        .results-header {
            background-color: #1e88e5;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
     
        .results-content {
            padding: 25px;
        }
     
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
     
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
     
        .result-title {
            font-weight: 600;
            color: #1e88e5;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
     
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
     
        .add-vendor-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            display: none;
        }
     
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
     
        .form-field {
            flex: 1;
            min-width: 250px;
        }
     
        .vehicle-numbers-container {
            margin-top: 15px;
        }
     
        .vehicle-number-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
     
        .remove-vehicle {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
     
        .add-vehicle {
            background-color: #9e9e9e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
     
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
     
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
     
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
     
        .suggestion-item:last-child {
            border-bottom: none;
        }
     
        .highlight {
            background-color: #e3f2fd;
            font-weight: bold;
        }
     
        .transport-details {
            margin-top: 30px;
        }
     
        .transport-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
     
        .transport-table th, .transport-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
     
        .transport-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
     
        .transport-table tr:hover {
            background-color: #f5f5f5;
        }
     
        .summary-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
     
        .summary-item {
            text-align: center;
            flex: 1;
        }
     
        .summary-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
     
        .summary-value {
            font-size: 24px;
            color: #1b5e20;
            font-weight: 700;
        }
     
        .summary-divider {
            width: 2px;
            height: 50px;
            background-color: #4caf50;
            margin: 0 20px;
        }
     
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-weight: 600;
        }
     
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e88e5;
        }
     
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
     
        .saved-results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            padding: 25px;
        }
     
        .saved-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
     
        .saved-results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
     
        .saved-results-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
        }
     
        .saved-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
     
        .saved-result-item:last-child {
            border-bottom: none;
        }
     
        .saved-result-info {
            flex: 1;
        }
     
        .saved-result-actions {
            display: flex;
            gap: 10px;
        }
     
        .btn-remove {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
     
        .btn-view {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
     
        .vendor-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
     
        .vendor-header {
            background-color: #e3f2fd;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
     
        .vendor-vehicles {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
     
        .vendor-vehicles.expanded {
            max-height: 500px;
            padding: 15px 20px;
        }
     
        .vehicle-option {
            padding: 10px 15px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
     
        .vehicle-option:hover {
            background-color: #f5f5f5;
        }
     
        .vehicle-option.selected {
            background-color: #e3f2fd;
            border-color: #1e88e5;
        }
     
        .amount-edit {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
     
        .amount-input {
            width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
     
        .btn-update {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
     
        .vehicle-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
     
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e88e5;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
     
        .dashboard-section {
            margin-bottom: 25px;
        }
     
        .dashboard-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
     
        .dashboard-summary-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
     
        .dashboard-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
     
        .dashboard-summary-item:last-child {
            margin-bottom: 0;
        }
     
        .dashboard-label {
            font-weight: 500;
            color: #555;
        }
     
        .dashboard-value {
            font-weight: 600;
            color: #1e88e5;
        }
     
        .dashboard-highlight {
            font-weight: 700;
            color: #1565c0;
            font-size: 1.1rem;
        }
     
        .product-breakdown {
            margin-top: 15px;
        }
     
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
     
        .product-name {
            font-weight: 500;
        }
     
        .product-qty {
            font-weight: 600;
            color: #2e7d32;
        }
     
        .product-amount {
            font-weight: 600;
            color: #d32f2f;
        }
     
        .dashboard-refresh {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
     
        .dashboard-refresh:hover {
            background-color: #1565c0;
        }
     
        .dashboard-loading {
            text-align: center;
            padding: 10px;
            color: #1e88e5;
            font-style: italic;
        }
     
        .vendor-total-summary {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
     
        .vendor-total-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 15px;
            text-align: center;
        }
     
        .vendor-total-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
     
        .vendor-total-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
     
        .vendor-total-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
     
        .vendor-total-value {
            font-size: 20px;
            color: #1b5e20;
            font-weight: 700;
        }
     
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
         
            .dashboard-sidebar {
                width: 100%;
                order: -1;
                margin-bottom: 20px;
            }
         
            .form-group, .form-field {
                min-width: 100%;
            }
         
            h1 {
                font-size: 2rem;
            }
         
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
         
            .transport-table {
                display: block;
                overflow-x: auto;
            }
         
            .saved-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
         
            .saved-result-actions {
                width: 100%;
                justify-content: flex-end;
            }
         
            .amount-edit {
                flex-direction: column;
                align-items: flex-start;
            }
         
            .amount-input {
                width: 100%;
            }
         
            .summary-box {
                flex-direction: column;
                gap: 15px;
            }
         
            .summary-divider {
                width: 100%;
                height: 2px;
                margin: 10px 0;
            }
         
            .vendor-total-details {
                flex-direction: column;
                gap: 10px;
            }
        }
     
        @media print {
            .search-section, .add-vendor-section, .btn-print, .saved-results-section, .dashboard-sidebar {
                display: none;
            }
         
            .results-section {
                display: block !important;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header>
                <h1>SGX - Transport Billing System</h1>
            </header>
         
            <section class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="vehicleSearch">Search Vehicle Number:</label>
                        <input type="text" id="vehicleSearch" placeholder="Start typing vehicle number (e.g., AP39UJ)" autocomplete="off">
                        <div class="suggestions-container" id="suggestionsContainer"></div>
                    </div>
                </div>
             
                <button type="button" onclick="searchVehicle()">Search Vehicle</button>
                <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Add New Vendor</button>
                <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
            </section>
         
            <section class="results-section" id="resultsSection">
                <div class="results-header">
                    <span>Vehicle Details</span>
                    <div>
                        <button type="button" class="btn-secondary" onclick="saveCurrentResult()">Save to List</button>
                        <button type="button" class="btn-print" onclick="printResults()">Print</button>
                    </div>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be displayed here -->
                </div>
            </section>
         
            <section class="add-vendor-section" id="addVendorSection">
                <div class="results-header">Add New Vendor</div>
                <div class="results-content">
                    <form id="vendorForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="partyName">Party Name:</label>
                                <input type="text" id="partyName" required>
                            </div>
                            <div class="form-field">
                                <label for="accountNo">Account Number:</label>
                                <input type="text" id="accountNo" required>
                            </div>
                        </div>
                     
                        <div class="form-row">
                            <div class="form-field">
                                <label for="bankName">Bank Name & Branch:</label>
                                <input type="text" id="bankName" required>
                            </div>
                            <div class="form-field">
                                <label for="beneficiary">Beneficiary:</label>
                                <input type="text" id="beneficiary" required>
                            </div>
                        </div>
                     
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pan">PAN Number:</label>
                                <input type="text" id="pan" required>
                            </div>
                        </div>
                     
                        <div class="form-row">
                            <div class="form-field">
                                <label>Vehicle Numbers:</label>
                                <div class="vehicle-numbers-container" id="vehicleNumbersContainer">
                                    <div class="vehicle-number-input">
                                        <input type="text" class="vehicleNumber" placeholder="Vehicle Number" required>
                                        <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>
                                    </div>
                                </div>
                                <button type="button" class="add-vehicle" onclick="addVehicleField()">Add Another Vehicle</button>
                            </div>
                        </div>
                     
                        <div class="form-row">
                            <button type="button" onclick="addNewVendor()">Save Vendor</button>
                            <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </section>
         
            <section class="saved-results-section" id="savedResultsSection">
                <div class="saved-results-header">
                    <div class="saved-results-title">Saved Results</div>
                    <div>
                        <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
                        <button type="button" class="btn-secondary" onclick="clearSavedResults()">Clear All</button>
                    </div>
                </div>
                <div class="saved-results-list" id="savedResultsList">
                    <!-- Saved results will be displayed here -->
                </div>
            </section>
        </div>
     
        <div class="dashboard-sidebar">
            <div class="dashboard-title">Monthly Dashboard</div>
         
            <div class="dashboard-section">
                <div class="dashboard-section-title">Overall Summary</div>
                <div class="dashboard-summary-box">
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Vehicles:</span>
                        <span class="dashboard-value" id="totalVehicles">0</span>
                    </div>
             
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Quantity:</span>
                        <span class="dashboard-value" id="totalQuantity">0.00</span>
                    </div>
                    <div class="dashboard-summary-item dashboard-highlight">
                        <span class="dashboard-label">Total Amount:</span>
                        <span class="dashboard-value" id="totalAmount">₹0.00</span>
                    </div>
                </div>
            </div>
         
            <div class="dashboard-section">
                <div class="dashboard-section-title">Product Breakdown</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="productBreakdown">
                        <!-- Product breakdown will be displayed here -->
                    </div>
                </div>
            </div>
         
            <div class="dashboard-section">
                <div class="dashboard-section-title">Top Vehicles</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="topVehicles">
                        <!-- Top vehicles will be displayed here -->
                    </div>
                </div>
            </div>
         
            <button type="button" class="dashboard-refresh" onclick="updateDashboard()">Refresh Dashboard</button>
        </div>
    </div>

    <!-- Load SheetJS with defer -->
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        'use strict';

        // -------------------------------------------------
        //  DATA
        // -------------------------------------------------
        let vehicleData = [
            { partyName: "YARA GOVIND RAO - BT -2 ( Balaji Transport )", accountNo: "29611100003742", bankName: "DCB Bank, Anakapalli", beneficiary: "YARA GOVIND RAO", pan: "AYBPY0969R", vehicleNumbers: ["AP39UY3435"] },
            { partyName: "YERRA BHAGYA LAKSHMI - BT- 1", accountNo: "42084751220", bankName: "SBI, Ankapalli", beneficiary: "YERRA BHAGYA LAKSHMI", pan: "FRCPB8273A", vehicleNumbers: ["AP39UY3345"] },
            { partyName: "GADASALA SHIVA", accountNo: "1420155000065560", bankName: "KVB", beneficiary: "Gadasala Shiva", pan: "BTSPG7175G", vehicleNumbers: ["AP39WC2389", "AP39UQ2489"] },
            { partyName: "Sri Modamamba Transport", accountNo: "6086101003133", bankName: "CANARA BANK", beneficiary: "Ommi Madhu babu", pan: "ABEYO1294K", vehicleNumbers: ["AP39UZ3335"] },
            { partyName: "Sri Vijayalaxmi Transport", accountNo: "868457131", bankName: "Indian Bank,Anakapalle", beneficiary: "S K Santosh Kumar", pan: "CWUPS1379C", vehicleNumbers: ["AP39W4518"] },
            { partyName: "SRI MODHAMAMBA TRANSPORT", accountNo: "6546322059", bankName: "Indian Bank Anakapalle", beneficiary: "MONDEPU GOPI", pan: "GDAPM7595D", vehicleNumbers: ["AP39W5005", "AP39UJ5678"] },
            { partyName: "SRI VARDHAN TRANSPORT", accountNo: "6086101005682", bankName: "CB Anakapalle", beneficiary: "PRIYANKA NAGULAPALLI", pan: "CCOPN9093G", vehicleNumbers: ["AP39W3579"] },
            { partyName: "SHREE NOOKAMBICA LORRY TRANSPORT", accountNo: "30893220505", bankName: "SBI, Anakapalle", beneficiary: "P.N.K.A Ananda Rao", pan: "CHOPP3166M", vehicleNumbers: ["AP39UF3245", "AP05TH2345", "AP39UP9239", "AP39WC9149"] },
            { partyName: "LAKSHMI SRINIVASA TRANSPORT", accountNo: "053501505619", bankName: "ICICI, Anakapalle", beneficiary: "Gali Venkata Nukaraju", pan: "BQDPG9659K", vehicleNumbers: ["AP39W0505", "AP39WC7499"] },
            { partyName: "SRI MODAMAMBA LORRY TRANSPORT -POLNATI RAMU", accountNo: "039301000039226", bankName: "Indian Overseas Bank-Anakapalli", beneficiary: "POLNATI RAMU", pan: "AMEPP6405E", vehicleNumbers: ["AP39TV2536", "AP39WB2536", "AP39WD2536"] },
            { partyName: "POLNATI LAKSHMANA", accountNo: "20393866584", bankName: "SBI, Anakapalle", beneficiary: "POLNATI LAKSHMANA", pan: "EHGPP6721J", vehicleNumbers: ["AP39TV2537"] },
            { partyName: "GADASALA VENKATA RAO", accountNo: "41897007408", bankName: "SBI, Anakapalle", beneficiary: "GADASALA VENKATA RAO", pan: "BNLPG8819G", vehicleNumbers: ["AP39UJ2489", "AP39UZ2489"] },
            { partyName: "Sri Durga Devi Lorry Services", accountNo: "30758927213", bankName: "SBI, Anakapalle", beneficiary: "N.Narisinga Rao", pan: "APCPN4125N", vehicleNumbers: ["AP39VE2979"] },
            { partyName: "Sri Balaji Transport", accountNo: "20286779205", bankName: "SBI", beneficiary: "Gangiredla Srinivasa Rao", pan: "BZJPG9951K", vehicleNumbers: ["AP39UE5163", "AP39VB2727", "AP39UP4799"] },
            { partyName: "BINDHU SREE TRANSPORT AND CONSTRUCTIONS", accountNo: "053505500548", bankName: "ICICI, Anakapalle", beneficiary: "NAMMI SUNITHA", pan: "BMHPB1489C", vehicleNumbers: ["AP39VC5289", "AP39UW2589"] },
            { partyName: "Sri Venkata Durga Lorry service", accountNo: "50100398807876", bankName: "HDFC, Anakapalle", beneficiary: "Ullingala Nageswar Rao", pan: "CKQPN5200B", vehicleNumbers: ["AP39TN2579", "AP39UJ2669"] },
            { partyName: "Mummina Srinu", accountNo: "31897791454", bankName: "SBI", beneficiary: "Mummina Srinu", pan: "NIEPS1843A", vehicleNumbers: ["AP39UZ3659"] },
            { partyName: "SRI MODAMAMBA LORRY TRANSPORT", accountNo: "386602010025075", bankName: "UNION BANK", beneficiary: "Lanka Nageswara Rao", pan: "AYWPL8780A", vehicleNumbers: ["AP39UU5665"] },
            { partyName: "R.K TRANSPORT", accountNo: "18862612000462", bankName: "PUNJAB NATIONAL BANK", beneficiary: "Ommi Venkata Rao", pan: "CACPV1217L", vehicleNumbers: ["AP39UG0559"] },
            { partyName: "SRI SIVA DURGA LORRY SERVICE", accountNo: "44005352428", bankName: "SBI, ANAKAPALLI", beneficiary: "Kommuri Durga Prasad", pan: "CKBPK7332L", vehicleNumbers: ["AP39WD8349"] },
            { partyName: "SRI MANIKANTA BALAJI LORRY TRANSPORT", accountNo: "33982901231", bankName: "SBI, Anakapalle", beneficiary: "M SOMUNAIDU", pan: "CLXPM8882N", vehicleNumbers: ["AP39WD4199"] },
            { partyName: "Sri Kanaka Durga LorrySERVICE", accountNo: "50100482507472", bankName: "HDFC, Anakapalle", beneficiary: "CH.POLANDRA", pan: "FRQPP2042K", vehicleNumbers: ["AP39UJ2399"] },
            { partyName: "K DURGA RAO", accountNo: "184010100508162", bankName: "AXIS BANK OF INDIA ANAKAPALLE", beneficiary: "K.DURGA RAO", pan: "BCBPR6347H", vehicleNumbers: ["AP31TN4302", "AP39VB8829"] },
            { partyName: "SIRI BUILDTECH", accountNo: "10230601834", bankName: "IDFC FIRST BANK", beneficiary: "Kondala Rao", pan: "CCAPK6960M", vehicleNumbers: ["AP39WH 3659"] },
            { partyName: "DURGALAMMATALLI LORRY SERVICE", accountNo: "32949321587", bankName: "SBI ANAKAPALLE", beneficiary: "DASARI GOVINDA", pan: "CMJPD4773Q", vehicleNumbers: ["AP39WE9299", "AP39UM4767"] },
            { partyName: "SREE MODHAMAMBHA TRANSPORT", accountNo: "386602010026387", bankName: "UNION BANK", beneficiary: "B HEMANTH KUMAR", pan: "CEGPB5646M", vehicleNumbers: ["AP39WH2769", "AP39WH1869"] },
            { partyName: "SRI PYDIMAMBA LORRY SERVICES", accountNo: "39080100013298", bankName: "BANK OF BARODA", beneficiary: "LOKIREDDI NAGABABU", pan: "CNZPN5078D", vehicleNumbers: ["AP39UV2345", "AP39UN3335", "AP39WE2345", "AP39VD5226", "AP39TU2489", "AP39WE3339", "AP39UD2345", "AP39UZ2345", "AP39W7119"] },
            { partyName: "Sri Kanaka Durga Lorry transprot", accountNo: "3512984417", bankName: "Kotak Mahindra Anakapalli", beneficiary: "Karanam Uma Maheswara Rao", pan: "IBOPK6921H", vehicleNumbers: ["AP39UJ1166", "AP39W2399"] },
            { partyName: "SRI BALA DURGA LORRY SERVICE", accountNo: "36055252391", bankName: "SBI, Anakapalle", beneficiary: "J.SRI PADHAVALLAABHA", pan: "CCEPJ2049G", vehicleNumbers: ["AP39VF2339"] },
            { partyName: "SRI MODA VENKATA SURYA LORRY SERVICE", accountNo: "33808097568", bankName: "ANAKAPALLE", beneficiary: "POLNATI TATA RAO", pan: "BYEPP6263R", vehicleNumbers: ["AP39UC6939"] },
            { partyName: "POLNATI ANNAPURNA", accountNo: "6086101003959", bankName: "CANARA BANK", beneficiary: "Polnati Annapuran", pan: "DWOPP2749J", vehicleNumbers: ["AP39WC9149", "AP39UP9239"] },
            { partyName: "SRI VIJAYA DURGA ENTERPRISES", accountNo: "31499967751", bankName: "SBI ANAKAPALLE", beneficiary: "VASADI RAMESH", pan: "AGNPV7563J", vehicleNumbers: [] },
            { partyName: "Sri Polnati Venkata Srinivas Rao", accountNo: "11040675260", bankName: "SBI, Anakapalle", beneficiary: "Polnati Venkata Srinivasrao", pan: "EMOPP4189M", vehicleNumbers: ["AP39UH2489"] }
        ];

        let transportData = [];
        let savedResults = [];

        // -------------------------------------------------
        //  INITIALISATION
        // -------------------------------------------------
        function initApp() {
            setupSearchFunctionality();
            loadTransportData();
            loadSavedResults();
        }

        // -------------------------------------------------
        //  LOAD TRANSPORT EXCEL
        // -------------------------------------------------
        async function loadTransportData() {
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '<div class="loading">Loading transport data...</div>';

            try {
                const githubUrl = 'https://raw.githubusercontent.com/bimal-bp/SEP_TRANSPORT_BILL/main/SEP_trans_bill.xlsx';
                const resp = await fetch(githubUrl);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const arrayBuffer = await resp.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1, raw:false, dateNF:'yyyy-mm-dd'});
                processTransportData(json);
                resultsContent.innerHTML = '';
                updateDashboard();
            } catch (e) {
                console.error(e);
                resultsContent.innerHTML = '<div class="no-results">Error loading data.</div>';
            }
        }

        function processTransportData(json) {
            if (!json || json.length < 2) return;
            const headers = json[0].map(h => (h ?? '').toString().trim());
            transportData = json.slice(1).map(row => {
                const obj = {};
                headers.forEach((h, i) => {
                    if (h && row[i] !== undefined) {
                        obj[h] = h === 'Accounting Date' ? convertExcelDate(row[i]) : row[i];
                    }
                });
                return obj;
            });
        }

        // -------------------------------------------------
        //  DASHBOARD
        // -------------------------------------------------
        function updateDashboard() {
            if (transportData.length === 0) {
                document.getElementById('totalVehicles').textContent = '0';
                document.getElementById('totalQuantity').textContent = '0.00';
                document.getElementById('totalAmount').textContent = '₹0.00';
                return;
            }

            const totalVehicles = new Set();
            let totalQuantity = 0, totalAmount = 0;
            const productBreakdown = {}, vehicleBreakdown = {};

            transportData.forEach(record => {
                const v = (record['VEHICLE NO'] || '').toString().trim().toUpperCase();
                if (v) totalVehicles.add(v);
                if (!vehicleBreakdown[v]) vehicleBreakdown[v] = {qty:0, amt:0};

                const qty = parseFloat(record['NET WT']) || 0;
                const amt = parseFloat(record['Transport Amount']) || 0;
                totalQuantity += qty;
                totalAmount += amt;

                const prod = record['Material'] || 'Unknown';
                if (!productBreakdown[prod]) productBreakdown[prod] = {qty:0, amt:0};
                productBreakdown[prod].qty += qty;
                productBreakdown[prod].amt += amt;

                vehicleBreakdown[v].qty += qty;
                vehicleBreakdown[v].amt += amt;
            });

            document.getElementById('totalVehicles').textContent = totalVehicles.size;
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;

            const pb = document.getElementById('productBreakdown'); pb.innerHTML = '';
            Object.entries(productBreakdown).sort((a,b)=>b[1].qty-a[1].qty).forEach(([p,d])=>{
                const el = document.createElement('div'); el.className='product-item';
                el.innerHTML = `<div class="product-name">${p}</div><div class="product-qty">${d.qty.toFixed(2)}</div><div class="product-amount">₹${d.amt.toFixed(2)}</div>`;
                pb.appendChild(el);
            });

            const tv = document.getElementById('topVehicles'); tv.innerHTML = '';
            Object.entries(vehicleBreakdown).sort((a,b)=>b[1].amt-a[1].amt).slice(0,5).forEach(([v,d])=>{
                const el = document.createElement('div'); el.className='product-item';
                el.innerHTML = `<div class="product-name">${v}</div><div class="product-qty">${d.qty.toFixed(2)}</div><div class="product-amount">₹${d.amt.toFixed(2)}</div>`;
                tv.appendChild(el);
            });
        }

        // -------------------------------------------------
        //  SEARCH / SUGGESTIONS
        // -------------------------------------------------
        function setupSearchFunctionality() {
            const input = document.getElementById('vehicleSearch');
            const cont = document.getElementById('suggestionsContainer');

            input.addEventListener('input', () => {
                const term = input.value.trim().toUpperCase();
                if (!term) { cont.style.display='none'; return; }
                const matches = getMatchingVehicles(term);
                displaySuggestions(matches, term);
            });

            document.addEventListener('click', e => {
                if (!input.contains(e.target) && !cont.contains(e.target)) cont.style.display='none';
            });

            input.addEventListener('keydown', e => {
                const items = cont.querySelectorAll('.suggestion-item');
                const active = cont.querySelector('.suggestion-item.active');

                if (e.key==='ArrowDown') { e.preventDefault(); if (items.length) (active ? items[(Array.from(items).indexOf(active)+1)%items.length] : items[0]).classList.add('active'); }
                else if (e.key==='ArrowUp') { e.preventDefault(); if (active) { const i=Array.from(items).indexOf(active)-1; items[i<0?items.length-1:i].classList.add('active'); active.classList.remove('active'); } }
                else if (e.key==='Enter') { e.preventDefault(); if (active) { input.value=active.textContent; cont.style.display='none'; searchVehicle(); } else searchVehicle(); }
            });
        }

        function getMatchingVehicles(term) {
            const set = new Set();
            vehicleData.forEach(v => v.vehicleNumbers.forEach(n => { if (n && n.toUpperCase().includes(term)) set.add(n); }));
            transportData.forEach(r => { const v=(r['VEHICLE NO']||'').toString().trim().toUpperCase(); if (v.includes(term)) set.add(v); });
            return Array.from(set).sort((a,b)=>a.indexOf(term)-b.indexOf(term));
        }

        function displaySuggestions(matches, term) {
            const cont = document.getElementById('suggestionsContainer'); cont.innerHTML='';
            if (!matches.length) { cont.style.display='none'; return; }
            matches.forEach(m => {
                const el = document.createElement('div'); el.className='suggestion-item';
                el.innerHTML = m.replace(new RegExp(term,'gi'), '<span class="highlight">$&</span>');
                el.onclick = () => { document.getElementById('vehicleSearch').value=m; cont.style.display='none'; searchVehicle(); };
                el.onmouseover = () => { cont.querySelectorAll('.suggestion-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); };
                cont.appendChild(el);
            });
            cont.style.display='block';
        }

        // -------------------------------------------------
        //  MAIN SEARCH
        // -------------------------------------------------
        function searchVehicle() {
            const term = document.getElementById('vehicleSearch').value.trim().toUpperCase();
            if (!term) return alert('Enter a vehicle number');

            const vendorMatches = vehicleData.filter(v => v.vehicleNumbers.includes(term));

            // store full context BEFORE display
            window.currentSearch = {
                vehicleNumber: term,
                vendorDetails: vendorMatches,
                transportRecords: transportData.filter(r => (r['VEHICLE NO']||'').toString().trim().toUpperCase()===term),
                allVendorVehicles: [],
                vendorTotals: {totalVehicles:0,totalRecords:0,totalQuantity:0,totalAmount:0},
                manualAmount: null
            };

            const allVeh = new Set();
            vendorMatches.forEach(v => v.vehicleNumbers.forEach(n => allVeh.add(n)));
            window.currentSearch.allVendorVehicles = Array.from(allVeh);

            displayResults(vendorMatches, term);
        }

        function displayResults(vendorMatches, searchValue) {
            const sec = document.getElementById('resultsSection');
            const cont = document.getElementById('resultsContent'); cont.innerHTML='';

            if (vendorMatches.length===0) {
                const trans = window.currentSearch.transportRecords;
                if (trans.length) {
                    cont.innerHTML = '<div class="warning"><strong>Note:</strong> Vendor details not found, but transport records exist.</div>';
                    displayTransportDetails(searchValue, trans);
                } else {
                    cont.innerHTML = '<div class="no-results">No data found.</div>';
                }
                sec.style.display='block'; return;
            }

            const groups = {};
            vendorMatches.forEach(v => {
                const k = `${v.partyName}|${v.pan}`;
                if (!groups[k]) groups[k] = {vendor:v, vehicles:[]};
                v.vehicleNumbers.forEach(n => { if (!groups[k].vehicles.includes(n)) groups[k].vehicles.push(n); });
            });

            Object.values(groups).forEach((g, idx) => {
                const vg = document.createElement('div'); vg.className='vendor-group';
                const hdr = document.createElement('div'); hdr.className='vendor-header';
                hdr.innerHTML = `<div><div class="result-title">${g.vendor.partyName}</div><div><strong>PAN:</strong> ${g.vendor.pan}</div></div><div>${g.vehicles.length} Vehicles</div>`;
                hdr.onclick = () => document.getElementById(`veh${idx}`).classList.toggle('expanded');
                vg.appendChild(hdr);

                const vehDiv = document.createElement('div'); vehDiv.id=`veh${idx}`; vehDiv.className='vendor-vehicles';
                g.vehicles.forEach(vn => {
                    const opt = document.createElement('div'); opt.className='vehicle-option';
                    if (vn===searchValue) opt.classList.add('selected');
                    opt.textContent = vn;
                    opt.onclick = () => { document.getElementById('vehicleSearch').value=vn; searchVehicle(); };
                    vehDiv.appendChild(opt);
                });
                vg.appendChild(vehDiv);
                cont.appendChild(vg);

                const det = document.createElement('div'); det.className='result-item';
                det.innerHTML = `<div><strong>Bank A/c:</strong> ${g.vendor.accountNo}</div>
                                 <div><strong>Bank:</strong> ${g.vendor.bankName}</div>
                                 <div><strong>Beneficiary:</strong> ${g.vendor.beneficiary}</div>`;
                cont.appendChild(det);

                displayVendorTransportDetails(g.vendor, g.vehicles);
            });

            sec.style.display='block';
            sec.scrollIntoView({behavior:'smooth'});
        }

        function displayVendorTransportDetails(vendor, vehicleNumbers) {
            const allRecs = [];
            let totQty=0, totAmt=0, totRec=0;

            vehicleNumbers.forEach(vn => {
                const recs = transportData.filter(r => (r['VEHICLE NO']||'').toString().trim().toUpperCase()===vn);
                recs.forEach(r => { totQty+=parseFloat(r['NET WT'])||0; totAmt+=parseFloat(r['Transport Amount'])||0; totRec++; });
                allRecs.push(...recs);
            });

            window.currentSearch.vendorTotals = {totalVehicles:vehicleNumbers.length, totalRecords:totRec, totalQuantity:totQty, totalAmount:totAmt};

            const sum = document.createElement('div'); sum.className='vendor-total-summary';
            sum.innerHTML = `
                <div class="vendor-total-title">Vendor Total Summary</div>
                <div class="vendor-total-details">
                    <div class="vendor-total-item"><div class="vendor-total-label">Vehicles</div><div class="vendor-total-value">${vehicleNumbers.length}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Records</div><div class="vendor-total-value">${totRec}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Quantity</div><div class="vendor-total-value">${totQty.toFixed(2)}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Amount</div><div class="vendor-total-value">₹${totAmt.toFixed(2)}</div></div>
                </div>`;
            document.getElementById('resultsContent').appendChild(sum);

            vehicleNumbers.forEach(vn => {
                const recs = allRecs.filter(r => (r['VEHICLE NO']||'').toString().trim().toUpperCase()===vn);
                if (recs.length) displayTransportDetails(vn, recs);
            });
        }

        function displayTransportDetails(vehicleNumber, records) {
            if (!records.length) return;
            const div = document.createElement('div'); div.className='transport-details';
            const safe = vehicleNumber.replace(/\s+/g,'_');
            div.innerHTML = `
                <div class="result-title">Transport Details for Vehicle: ${vehicleNumber}</div>
                <table class="transport-table">
                    <thead><tr><th>Date</th><th>Customer</th><th>Vehicle</th><th>Material</th><th>Net Wt</th><th>Rate</th><th>Amount</th></tr></thead>
                    <tbody id="tbody_${safe}"></tbody>
                </table>
                <div class="summary-box" id="summary_${safe}">
                    <div class="summary-item"><div class="summary-label">Records</div><div class="summary-value" id="recs_${safe}">0</div></div>
                    <div class="summary-divider"></div>
                    <div class="summary-item"><div class="summary-label">Quantity</div><div class="summary-value" id="qty_${safe}">0</div></div>
                    <div class="summary-divider"></div>
                    <div class="summary-item"><div class="summary-label">Amount</div><div class="summary-value" id="amt_${safe}">0.00</div></div>
                </div>
                <div class="amount-edit">
                    <label for="manual_${safe}">Manual Amount:</label>
                    <input type="number" id="manual_${safe}" class="amount-input" placeholder="Enter amount">
                    <button type="button" class="btn-update" onclick="updateTotalAmount('${vehicleNumber}')">Update</button>
                </div>`;
            document.getElementById('resultsContent').appendChild(div);

            const tbody = document.getElementById(`tbody_${safe}`);
            let qty=0, amt=0;
            records.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${formatDateForDisplay(r['Accounting Date'])}</td>
                    <td>${r['NAME OF THE CUSTOMER']||''}</td>
                    <td>${r['VEHICLE NO']||''}</td>
                    <td>${r['Material']||''}</td>
                    <td>${r['NET WT']||''}</td>
                    <td>${r['Transport Rate']||''}</td>
                    <td>${r['Transport Amount']||''}</td>`;
                tbody.appendChild(tr);
                qty += parseFloat(r['NET WT'])||0;
                amt += parseFloat(r['Transport Amount'])||0;
            });

            document.getElementById(`recs_${safe}`).textContent = records.length;
            document.getElementById(`qty_${safe}`).textContent = qty.toFixed(2);
            document.getElementById(`amt_${safe}`).textContent = amt.toFixed(2);
            document.getElementById(`manual_${safe}`).value = amt.toFixed(2);
        }

        function updateTotalAmount(vehicleNumber) {
            const safe = vehicleNumber.replace(/\s+/g,'_');
            const val = parseFloat(document.getElementById(`manual_${safe}`).value);
            if (isNaN(val)) return alert('Enter a valid amount');
            document.getElementById(`amt_${safe}`).textContent = val.toFixed(2);
            window.currentSearch.manualAmount = val;
        }

        // -------------------------------------------------
        //  SAVE TO LIST
        // -------------------------------------------------
        function saveCurrentResult() {
            if (!window.currentSearch) return alert('Nothing to save');

            const vendor = window.currentSearch.vendorDetails[0] || null;
            const allVeh = window.currentSearch.allVendorVehicles;
            const key = vendor ? `${vendor.partyName}|${vendor.pan}` : window.currentSearch.vehicleNumber;

            const allRecs = [];
            let totQty=0, totAmt=0, totRec=0;
            allVeh.forEach(vn => {
                const recs = transportData.filter(r => (r['VEHICLE NO']||'').toString().trim().toUpperCase()===vn);
                recs.forEach(r => { totQty+=parseFloat(r['NET WT'])||0; totAmt+=parseFloat(r['Transport Amount'])||0; totRec++; });
                allRecs.push(...recs);
            });

            const finalAmt = window.currentSearch.manualAmount ?? totAmt;

            const obj = {
                vehicleNumber: window.currentSearch.vehicleNumber,
                vendorDetails: vendor ? [vendor] : [],
                allVendorVehicles: allVeh,
                allVendorTransportRecords: allRecs,
                vendorTotals: {totalVehicles:allVeh.length, totalRecords:totRec, totalQuantity:totQty, totalAmount:finalAmt},
                timestamp: new Date().toISOString()
            };

            const idx = savedResults.findIndex(r => {
                const k = r.vendorDetails[0] ? `${r.vendorDetails[0].partyName}|${r.vendorDetails[0].pan}` : r.vehicleNumber;
                return k===key;
            });

            if (idx>-1) savedResults[idx] = obj;
            else savedResults.push(obj);

            saveSavedResults();
            displaySavedResults();
            alert('Result saved!');
        }

        // -------------------------------------------------
        //  SAVED RESULTS
        // -------------------------------------------------
        function loadSavedResults() {
            const raw = localStorage.getItem('transportSavedResults');
            if (raw) { savedResults = JSON.parse(raw); displaySavedResults(); }
        }
        function saveSavedResults() { localStorage.setItem('transportSavedResults', JSON.stringify(savedResults)); }

        function displaySavedResults() {
            const list = document.getElementById('savedResultsList');
            if (!savedResults.length) { list.innerHTML='<div class="no-results">No saved results.</div>'; return; }
            list.innerHTML='';
            savedResults.forEach((r,i) => {
                const v = r.vendorDetails[0] || null;
                const t = r.vendorTotals;
                const el = document.createElement('div'); el.className='saved-result-item';
                el.innerHTML = `
                    <div class="saved-result-info">
                        <div class="result-title">${v?v.partyName:'No Vendor'}</div>
                        <div><strong>PAN:</strong> ${v?v.pan:'N/A'}</div>
                        <div><strong>Vehicles:</strong> ${t.totalVehicles}</div>
                        <div><strong>Records:</strong> ${t.totalRecords}</div>
                        <div><strong>Qty:</strong> ${t.totalQuantity.toFixed(2)}</div>
                        <div><strong>Amount:</strong> ₹${t.totalAmount.toFixed(2)}</div>
                    </div>
                    <div class="saved-result-actions">
                        <button type="button" class="btn-view" onclick="viewSavedResult(${i})">View</button>
                        <button type="button" class="btn-remove" onclick="removeSavedResult(${i})">Remove</button>
                    </div>`;
                list.appendChild(el);
            });
        }

        function viewSavedResult(idx) {
            const r = savedResults[idx];
            if (!r) return;
            const first = r.allVendorVehicles[0] || r.vehicleNumber;
            document.getElementById('vehicleSearch').value = first;
            window.currentSearch = {
                vehicleNumber: first,
                vendorDetails: r.vendorDetails,
                transportRecords: [],
                allVendorVehicles: r.allVendorVehicles,
                vendorTotals: r.vendorTotals,
                manualAmount: r.vendorTotals.totalAmount !==
                    r.allVendorTransportRecords.reduce((s,rec)=>s+(parseFloat(rec['Transport Amount'])||0),0)
                    ? r.vendorTotals.totalAmount : null
            };
            displayResults(r.vendorDetails, first);
        }

        function removeSavedResult(idx) {
            if (confirm('Remove this saved result?')) {
                savedResults.splice(idx,1);
                saveSavedResults();
                displaySavedResults();
            }
        }

        function clearSavedResults() {
            if (!savedResults.length) return alert('Nothing to clear');
            if (confirm('Clear **all** saved results?')) {
                savedResults = [];
                saveSavedResults();
                displaySavedResults();
            }
        }

        // -------------------------------------------------
        //  DOWNLOAD EXCEL
        // -------------------------------------------------
        function downloadSavedResults() {
            if (!savedResults.length) return alert('No saved results to export.');

            function tryExport(attempts=0) {
                if (typeof XLSX !== 'undefined') { doExport(); }
                else if (attempts<20) { setTimeout(()=>tryExport(attempts+1),200); }
                else alert('Excel library failed to load.');
            }
            tryExport();

            function doExport() {
                const wb = XLSX.utils.book_new();

                // Summary
                const sum = [['Vendor','PAN','A/c No','Bank','Beneficiary','Vehicles','Records','Qty','Amount']];
                savedResults.forEach(r => {
                    const v = r.vendorDetails[0] || {};
                    const t = r.vendorTotals;
                    sum.push([v.partyName||'N/A', v.pan||'N/A', v.accountNo||'N/A',
                              v.bankName||'N/A', v.beneficiary||'N/A',
                              t.totalVehicles, t.totalRecords, t.totalQuantity, t.totalAmount]);
                });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sum), 'Summary');

                // One sheet per vendor
                savedResults.forEach((r,i) => {
                    const v = r.vendorDetails[0] || {};
                    const safe = (v.partyName||`Vendor_${i+1}`).replace(/[^\w]/g,'_').substring(0,31);
                    const rows = [['Date','Customer','Vehicle','Material','Net Wt','Rate','Amount']];
                    r.allVendorTransportRecords.forEach(rec => {
                        rows.push([
                            formatDateForDisplay(rec['Accounting Date']),
                            rec['NAME OF THE CUSTOMER']||'',
                            rec['VEHICLE NO']||'',
                            rec['Material']||'',
                            rec['NET WT']||'',
                            rec['Transport Rate']||'',
                            rec['Transport Amount']||''
                        ]);
                    });
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), safe);
                });

                const file = `Transport_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, file);
            }
        }

        // -------------------------------------------------
        //  MISC
        // -------------------------------------------------
        function printResults() { window.print(); }

        function toggleAddVendorForm() {
            const sec = document.getElementById('addVendorSection');
            const res = document.getElementById('resultsSection');
            if (sec.style.display==='block') {
                sec.style.display='none';
                document.getElementById('vendorForm').reset();
                const cont = document.getElementById('vehicleNumbersContainer');
                while (cont.children.length>1) cont.removeChild(cont.lastChild);
            } else {
                sec.style.display='block';
                res.style.display='none';
                sec.scrollIntoView({behavior:'smooth'});
            }
        }

        function addVehicleField() {
            const cont = document.getElementById('vehicleNumbersContainer');
            const div = document.createElement('div'); div.className='vehicle-number-input';
            div.innerHTML = `<input type="text" class="vehicleNumber" placeholder="Vehicle Number"><button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>`;
            cont.appendChild(div);
        }

        function removeVehicleField(btn) {
            const cont = document.getElementById('vehicleNumbersContainer');
            if (cont.children.length>1) cont.removeChild(btn.parentNode);
        }

        function addNewVendor() {
            const party = document.getElementById('partyName').value.trim();
            const acc = document.getElementById('accountNo').value.trim();
            const bank = document.getElementById('bankName').value.trim();
            const ben = document.getElementById('beneficiary').value.trim();
            const pan = document.getElementById('pan').value.trim();
            const inputs = document.querySelectorAll('.vehicleNumber');
            const veh = Array.from(inputs).map(i=>i.value.trim().toUpperCase()).filter(v=>v);
            if (!party||!acc||!bank||!ben||!pan||veh.length===0) return alert('Fill all fields');
            vehicleData.push({partyName:party, accountNo:acc, bankName:bank, beneficiary:ben, pan, vehicleNumbers:veh});
            alert('Vendor added!');
            document.getElementById('vendorForm').reset();
            toggleAddVendorForm();
        }

        // -------------------------------------------------
        //  HELPERS
        // -------------------------------------------------
        function convertExcelDate(v) {
            if (typeof v==='string' && v.includes('-')) return v;
            if (typeof v==='number') {
                const d = new Date(new Date(1900,0,1).getTime() + (v-2)*86400000);
                return d.toISOString().split('T')[0];
            }
            return v;
        }

        function formatDateForDisplay(v) {
            if (!v) return '';
            if (typeof v==='string' && v.includes('-')) {
                const d = new Date(v);
                return !isNaN(d.getTime()) ? d.toLocaleDateString('en-IN') : v;
            }
            if (v instanceof Date) return v.toLocaleDateString('en-IN');
            return v;
        }

        window.onload = initApp;
    </script>
</body>
</html>
