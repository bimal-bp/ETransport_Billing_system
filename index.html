<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>October Transport Billing System</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
      
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
      
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            gap: 20px;
        }
      
        .main-content {
            flex: 1;
        }
      
        .dashboard-sidebar {
            width: 300px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: fit-content;
        }
      
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
      
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
      
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
      
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
      
        .form-group {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
      
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
      
        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
      
        select:focus, input:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
        }
      
        button {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 25px;
        }
      
        button:hover {
            background-color: #1565c0;
        }
      
        .btn-secondary {
            background-color: #4caf50;
            margin-left: 10px;
        }
      
        .btn-secondary:hover {
            background-color: #388e3c;
        }
      
        .btn-print {
            background-color: #ff9800;
            margin-left: 10px;
        }
      
        .btn-print:hover {
            background-color: #f57c00;
        }
      
        .btn-download {
            background-color: #9c27b0;
            margin-left: 10px;
        }
      
        .btn-download:hover {
            background-color: #7b1fa2;
        }
      
        .results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
      
        .results-header {
            background-color: #1e88e5;
            color: white;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
      
        .results-content {
            padding: 25px;
        }
      
        .result-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
      
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
      
        .result-title {
            font-weight: 600;
            color: #1e88e5;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
      
        .no-results {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
      
        .add-vendor-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            display: none;
        }
      
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
      
        .form-field {
            flex: 1;
            min-width: 250px;
        }
      
        .vehicle-numbers-container {
            margin-top: 15px;
        }
      
        .vehicle-number-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
      
        .remove-vehicle {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
      
        .add-vehicle {
            background-color: #9e9e9e;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
      
        .suggestions-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
      
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
      
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
      
        .suggestion-item:last-child {
            border-bottom: none;
        }
      
        .highlight {
            background-color: #e3f2fd;
            font-weight: bold;
        }
      
        .transport-details {
            margin-top: 30px;
        }
      
        .transport-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
      
        .transport-table th, .transport-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
      
        .transport-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
      
        .transport-table tr:hover {
            background-color: #f5f5f5;
        }
      
        .summary-box {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
      
        .summary-item {
            text-align: center;
            flex: 1;
        }
      
        .summary-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
      
        .summary-value {
            font-size: 24px;
            color: #1b5e20;
            font-weight: 700;
        }
      
        .summary-divider {
            width: 2px;
            height: 50px;
            background-color: #4caf50;
            margin: 0 20px;
        }
      
        .summary {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            font-weight: 600;
        }
      
        .loading {
            text-align: center;
            padding: 20px;
            color: #1e88e5;
        }
      
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
      
        .saved-results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
            padding: 25px;
        }
      
        .saved-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
      
        .saved-results-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }
      
        .saved-results-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
        }
      
        .saved-result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
      
        .saved-result-item:last-child {
            border-bottom: none;
        }
      
        .saved-result-info {
            flex: 1;
        }
      
        .saved-result-actions {
            display: flex;
            gap: 10px;
        }
      
        .btn-remove {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
      
        .btn-view {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
      
        .vendor-group {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
      
        .vendor-header {
            background-color: #e3f2fd;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
      
        .vendor-vehicles {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
      
        .vendor-vehicles.expanded {
            max-height: 500px;
            padding: 15px 20px;
        }
      
        .vehicle-option {
            padding: 10px 15px;
            margin: 5px 0;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
      
        .vehicle-option:hover {
            background-color: #f5f5f5;
        }
      
        .vehicle-option.selected {
            background-color: #e3f2fd;
            border-color: #1e88e5;
        }
      
        .amount-edit {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
      
        .amount-input {
            width: 150px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
      
        .btn-update {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
      
        .vehicle-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
      
        .dashboard-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e88e5;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
      
        .dashboard-section {
            margin-bottom: 25px;
        }
      
        .dashboard-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
      
        .dashboard-summary-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
      
        .dashboard-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
      
        .dashboard-summary-item:last-child {
            margin-bottom: 0;
        }
      
        .dashboard-label {
            font-weight: 500;
            color: #555;
        }
      
        .dashboard-value {
            font-weight: 600;
            color: #1e88e5;
        }
      
        .dashboard-highlight {
            font-weight: 700;
            color: #1565c0;
            font-size: 1.1rem;
        }
      
        .product-breakdown {
            margin-top: 15px;
        }
      
        .product-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
      
        .product-name {
            font-weight: 500;
        }
      
        .product-qty {
            font-weight: 600;
            color: #2e7d32;
        }
      
        .product-amount {
            font-weight: 600;
            color: #d32f2f;
        }
      
        .dashboard-refresh {
            background-color: #1e88e5;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
      
        .dashboard-refresh:hover {
            background-color: #1565c0;
        }
      
        .dashboard-loading {
            text-align: center;
            padding: 10px;
            color: #1e88e5;
            font-style: italic;
        }
      
        .vendor-total-summary {
            background-color: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
      
        .vendor-total-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1b5e20;
            margin-bottom: 15px;
            text-align: center;
        }
      
        .vendor-total-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
      
        .vendor-total-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
      
        .vendor-total-label {
            font-size: 14px;
            color: #2e7d32;
            margin-bottom: 5px;
            font-weight: 600;
        }
      
        .vendor-total-value {
            font-size: 20px;
            color: #1b5e20;
            font-weight: 700;
        }
      
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
          
            .dashboard-sidebar {
                width: 100%;
                order: -1;
                margin-bottom: 20px;
            }
          
            .form-group, .form-field {
                min-width: 100%;
            }
          
            h1 {
                font-size: 2rem;
            }
          
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
          
            .transport-table {
                display: block;
                overflow-x: auto;
            }
          
            .saved-result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
          
            .saved-result-actions {
                width: 100%;
                justify-content: flex-end;
            }
          
            .amount-edit {
                flex-direction: column;
                align-items: flex-start;
            }
          
            .amount-input {
                width: 100%;
            }
          
            .summary-box {
                flex-direction: column;
                gap: 15px;
            }
          
            .summary-divider {
                width: 100%;
                height: 2px;
                margin: 10px 0;
            }
          
            .vendor-total-details {
                flex-direction: column;
                gap: 10px;
            }
        }
      
        @media print {
            .search-section, .add-vendor-section, .btn-print, .saved-results-section, .dashboard-sidebar {
                display: none;
            }
          
            .results-section {
                display: block !important;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <header>
                <h1>SGX - Transport Billing System</h1>
            </header>
          
            <section class="search-section">
                <div class="search-form">
                    <div class="form-group">
                        <label for="vehicleSearch">Search Vehicle Number:</label>
                        <input type="text" id="vehicleSearch" placeholder="Start typing vehicle number (e.g., AP39UJ)" autocomplete="off">
                        <div class="suggestions-container" id="suggestionsContainer"></div>
                    </div>
                </div>
              
                <button type="button" onclick="searchVehicle()">Search Vehicle</button>
                <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Add New Vendor</button>
                <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
            </section>
          
            <section class="results-section" id="resultsSection">
                <div class="results-header">
                    <span>Vehicle Details</span>
                    <div>
                        <button type="button" class="btn-secondary" onclick="saveCurrentResult()">Save to List</button>
                        <button type="button" class="btn-print" onclick="printResults()">Print</button>
                    </div>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be displayed here -->
                </div>
            </section>
          
            <section class="add-vendor-section" id="addVendorSection">
                <div class="results-header">Add New Vendor</div>
                <div class="results-content">
                    <form id="vendorForm">
                        <div class="form-row">
                            <div class="form-field">
                                <label for="partyName">Party Name:</label>
                                <input type="text" id="partyName" required>
                            </div>
                            <div class="form-field">
                                <label for="accountNo">Account Number:</label>
                                <input type="text" id="accountNo" required>
                            </div>
                        </div>
                      
                        <div class="form-row">
                            <div class="form-field">
                                <label for="bankName">Bank Name & Branch:</label>
                                <input type="text" id="bankName" required>
                            </div>
                            <div class="form-field">
                                <label for="beneficiary">Beneficiary:</label>
                                <input type="text" id="beneficiary" required>
                            </div>
                        </div>
                      
                        <div class="form-row">
                            <div class="form-field">
                                <label for="pan">PAN Number:</label>
                                <input type="text" id="pan" required>
                            </div>
                        </div>
                      
                        <div class="form-row">
                            <div class="form-field">
                                <label>Vehicle Numbers:</label>
                                <div class="vehicle-numbers-container" id="vehicleNumbersContainer">
                                    <div class="vehicle-number-input">
                                        <input type="text" class="vehicleNumber" placeholder="Vehicle Number" required>
                                        <button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>
                                    </div>
                                </div>
                                <button type="button" class="add-vehicle" onclick="addVehicleField()">Add Another Vehicle</button>
                            </div>
                        </div>
                      
                        <div class="form-row">
                            <button type="button" onclick="addNewVendor()">Save Vendor</button>
                            <button type="button" class="btn-secondary" onclick="toggleAddVendorForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </section>
          
            <section class="saved-results-section" id="savedResultsSection">
                <div class="saved-results-header">
                    <div class="saved-results-title">Saved Results</div>
                    <div>
                        <button type="button" class="btn-download" onclick="downloadSavedResults()">Download Excel</button>
                        <button type="button" class="btn-secondary" onclick="clearSavedResults()">Clear All</button>
                    </div>
                </div>
                <div class="saved-results-list" id="savedResultsList">
                    <!-- Saved results will be displayed here -->
                </div>
            </section>
        </div>
      
        <div class="dashboard-sidebar">
            <div class="dashboard-title">Monthly Dashboard</div>
          
            <div class="dashboard-section">
                <div class="dashboard-section-title">Overall Summary</div>
                <div class="dashboard-summary-box">
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Vehicles:</span>
                        <span class="dashboard-value" id="totalVehicles">0</span>
                    </div>
              
                    <div class="dashboard-summary-item">
                        <span class="dashboard-label">Total Quantity:</span>
                        <span class="dashboard-value" id="totalQuantity">0.00</span>
                    </div>
                    <div class="dashboard-summary-item dashboard-highlight">
                        <span class="dashboard-label">Total Amount:</span>
                        <span class="dashboard-value" id="totalAmount">₹0.00</span>
                    </div>
                </div>
            </div>
          
            <div class="dashboard-section">
                <div class="dashboard-section-title">Product Breakdown</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="productBreakdown">
                        <!-- Product breakdown will be displayed here -->
                    </div>
                </div>
            </div>
          
            <div class="dashboard-section">
                <div class="dashboard-section-title">Top Vehicles</div>
                <div class="dashboard-summary-box">
                    <div class="product-breakdown" id="topVehicles">
                        <!-- Top vehicles will be displayed here -->
                    </div>
                </div>
            </div>
          
            <button type="button" class="dashboard-refresh" onclick="updateDashboard()">Refresh Dashboard</button>
        </div>
    </div>

    <!-- Load SheetJS with defer (critical for download to work) -->
    <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
        // Complete vehicle data
        let vehicleData = [
            { partyName: "YARA GOVIND RAO - BT -2 ( Balaji Transport )", accountNo: "29611100003742", bankName: "DCB Bank, Anakapalli", beneficiary: "YARA GOVIND RAO", pan: "AYBPY0969R", vehicleNumbers: ["AP39UY3435"] },
            { partyName: "YERRA BHAGYA LAKSHMI - BT- 1", accountNo: "42084751220", bankName: "SBI, Ankapalli", beneficiary: "YERRA BHAGYA LAKSHMI", pan: "FRCPB8273A", vehicleNumbers: ["AP39UY3345"] },
            { partyName: "GADASALA SHIVA", accountNo: "1420155000065560", bankName: "KVB", beneficiary: "Gadasala Shiva", pan: "BTSPG7175G", vehicleNumbers: ["AP39WC2389", "AP39UQ2489"] },
            { partyName: "Sri Modamamba Transport", accountNo: "6086101003133", bankName: "CANARA BANK", beneficiary: "Ommi Madhu babu", pan: "ABEYO1294K", vehicleNumbers: ["AP39UZ3335"] },
            { partyName: "Sri Vijayalaxmi Transport", accountNo: "868457131", bankName: "Indian Bank,Anakapalle", beneficiary: "S K Santosh Kumar", pan: "CWUPS1379C", vehicleNumbers: ["AP39W4518"] },
            { partyName: "SRI MODHAMAMBA TRANSPORT", accountNo: "6546322059", bankName: "Indian Bank Anakapalle", beneficiary: "MONDEPU GOPI", pan: "GDAPM7595D", vehicleNumbers: ["AP39W5005", "AP39UJ5678"] },
            { partyName: "SRI VARDHAN TRANSPORT", accountNo: "6086101005682", bankName: "CB Anakapalle", beneficiary: "PRIYANKA NAGULAPALLI", pan: "CCOPN9093G", vehicleNumbers: ["AP39W3579"] },
            { partyName: "SHREE NOOKAMBICA LORRY TRANSPORT", accountNo: "30893220505", bankName: "SBI, Anakapalle", beneficiary: "P.N.K.A Ananda Rao", pan: "CHOPP3166M", vehicleNumbers: ["AP39UF3245", "AP05TH2345", "AP39UP9239", "AP39WC9149"] },
            { partyName: "LAKSHMI SRINIVASA TRANSPORT", accountNo: "053501505619", bankName: "ICICI, Anakapalle", beneficiary: "Gali Venkata Nukaraju", pan: "BQDPG9659K", vehicleNumbers: ["AP39W0505", "AP39WC7499"] },
            { partyName: "SRI MODAMAMBA LORRY TRANSPORT -POLNATI RAMU", accountNo: "039301000039226", bankName: "Indian Overseas Bank-Anakapalli", beneficiary: "POLNATI RAMU", pan: "AMEPP6405E", vehicleNumbers: ["AP39TV2536", "AP39WB2536", "AP39WD2536"] },
            { partyName: "POLNATI LAKSHMANA", accountNo: "20393866584", bankName: "SBI, Anakapalle", beneficiary: "POLNATI LAKSHMANA", pan: "EHGPP6721J", vehicleNumbers: ["AP39TV2537"] },
            { partyName: "GADASALA VENKATA RAO", accountNo: "41897007408", bankName: "SBI, Anakapalle", beneficiary: "GADASALA VENKATA RAO", pan: "BNLPG8819G", vehicleNumbers: ["AP39UJ2489", "AP39UZ2489"] },
            { partyName: "Sri Durga Devi Lorry Services", accountNo: "30758927213", bankName: "SBI, Anakapalle", beneficiary: "N.Narisinga Rao", pan: "APCPN4125N", vehicleNumbers: ["AP39VE2979"] },
            { partyName: "Sri Balaji Transport", accountNo: "20286779205", bankName: "SBI", beneficiary: "Gangiredla Srinivasa Rao", pan: "BZJPG9951K", vehicleNumbers: ["AP39UE5163", "AP39VB2727", "AP39UP4799"] },
            { partyName: "BINDHU SREE TRANSPORT AND CONSTRUCTIONS", accountNo: "053505500548", bankName: "ICICI, Anakapalle", beneficiary: "NAMMI SUNITHA", pan: "BMHPB1489C", vehicleNumbers: ["AP39VC5289", "AP39UW2589"] },
            { partyName: "Sri Venkata Durga Lorry service", accountNo: "50100398807876", bankName: "HDFC, Anakapalle", beneficiary: "Ullingala Nageswar Rao", pan: "CKQPN5200B", vehicleNumbers: ["AP39TN2579", "AP39UJ2669"] },
            { partyName: "Mummina Srinu", accountNo: "31897791454", bankName: "SBI", beneficiary: "Mummina Srinu", pan: "NIEPS1843A", vehicleNumbers: ["AP39UZ3659"] },
            { partyName: "SRI MODAMAMBA LORRY TRANSPORT", accountNo: "386602010025075", bankName: "UNION BANK", beneficiary: "Lanka Nageswara Rao", pan: "AYWPL8780A", vehicleNumbers: ["AP39UU5665"] },
            { partyName: "R.K TRANSPORT", accountNo: "18862612000462", bankName: "PUNJAB NATIONAL BANK", beneficiary: "Ommi Venkata Rao", pan: "CACPV1217L", vehicleNumbers: ["AP39UG0559"] },
            { partyName: "SRI SIVA DURGA LORRY SERVICE", accountNo: "44005352428", bankName: "SBI, ANAKAPALLI", beneficiary: "Kommuri Durga Prasad", pan: "CKBPK7332L", vehicleNumbers: ["AP39WD8349"] },
            { partyName: "SRI MANIKANTA BALAJI LORRY TRANSPORT", accountNo: "33982901231", bankName: "SBI, Anakapalle", beneficiary: "M SOMUNAIDU", pan: "CLXPM8882N", vehicleNumbers: ["AP39WD4199"] },
            { partyName: "Sri Kanaka Durga LorrySERVICE", accountNo: "50100482507472", bankName: "HDFC, Anakapalle", beneficiary: "CH.POLANDRA", pan: "FRQPP2042K", vehicleNumbers: ["AP39UJ2399"] },
            { partyName: "K DURGA RAO", accountNo: "184010100508162", bankName: "AXIS BANK OF INDIA ANAKAPALLE", beneficiary: "K.DURGA RAO", pan: "BCBPR6347H", vehicleNumbers: ["AP31TN4302", "AP39VB8829"] },
            { partyName: "SIRI BUILDTECH", accountNo: "10230601834", bankName: "IDFC FIRST BANK", beneficiary: "Kondala Rao", pan: "CCAPK6960M", vehicleNumbers: ["AP39WH 3659"] },
            { partyName: "DURGALAMMATALLI LORRY SERVICE", accountNo: "32949321587", bankName: "SBI ANAKAPALLE", beneficiary: "DASARI GOVINDA", pan: "CMJPD4773Q", vehicleNumbers: ["AP39WE9299", "AP39UM4767"] },
            { partyName: "SREE MODHAMAMBHA TRANSPORT", accountNo: "386602010026387", bankName: "UNION BANK", beneficiary: "B HEMANTH KUMAR", pan: "CEGPB5646M", vehicleNumbers: ["AP39WH2769", "AP39WH1869"] },
            { partyName: "SRI PYDIMAMBA LORRY SERVICES", accountNo: "39080100013298", bankName: "BANK OF BARODA", beneficiary: "LOKIREDDI NAGABABU", pan: "CNZPN5078D", vehicleNumbers: ["AP39UV2345", "AP39UN3335", "AP39WE2345", "AP39VD5226", "AP39TU2489", "AP39WE3339", "AP39UD2345", "AP39UZ2345", "AP39W7119"] },
            { partyName: "Sri Kanaka Durga Lorry transprot", accountNo: "3512984417", bankName: "Kotak Mahindra Anakapalli", beneficiary: "Karanam Uma Maheswara Rao", pan: "IBOPK6921H", vehicleNumbers: ["AP39UJ1166", "AP39W2399"] },
            { partyName: "SRI BALA DURGA LORRY SERVICE", accountNo: "36055252391", bankName: "SBI, Anakapalle", beneficiary: "J.SRI PADHAVALLAABHA", pan: "CCEPJ2049G", vehicleNumbers: ["AP39VF2339"] },
            { partyName: "SRI MODA VENKATA SURYA LORRY SERVICE", accountNo: "33808097568", bankName: "ANAKAPALLE", beneficiary: "POLNATI TATA RAO", pan: "BYEPP6263R", vehicleNumbers: ["AP39UC6939"] },
            { partyName: "POLNATI ANNAPURNA", accountNo: "6086101003959", bankName: "CANARA BANK", beneficiary: "Polnati Annapuran", pan: "DWOPP2749J", vehicleNumbers: ["AP39WC9149", "AP39UP9239"] },
            { partyName: "SRI VIJAYA DURGA ENTERPRISES", accountNo: "31499967751", bankName: "SBI ANAKAPALLE", beneficiary: "VASADI RAMESH", pan: "AGNPV7563J", vehicleNumbers: [] },
            { partyName: "Sri Polnati Venkata Srinivas Rao", accountNo: "11040675260", bankName: "SBI, Anakapalle", beneficiary: "Polnati Venkata Srinivasrao", pan: "EMOPP4189M", vehicleNumbers: ["AP39UH2489"] }
        ];

        let transportData = [];
        let savedResults = [];

        function getVendorKey(vendor) {
            return vendor ? `${vendor.partyName}|${vendor.pan}` : null;
        }

        function initApp() {
            setupSearchFunctionality();
            loadTransportData();
            loadSavedResults();
        }

        async function loadTransportData() {
            try {
                const resultsContent = document.getElementById('resultsContent');
                resultsContent.innerHTML = '<div class="loading">Loading transport data...</div>';
                const githubUrl = 'https://raw.githubusercontent.com/bimal-bp/SEP_TRANSPORT_BILL/main/SEP_trans_bill.xlsx';
                const response = await fetch(githubUrl);
                if (!response.ok) throw new Error(`Failed to fetch data: ${response.status}`);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                            header: 1,
                            raw: false,
                            dateNF: 'yyyy-mm-dd'
                        });
                        processTransportData(jsonData, worksheet);
                        resultsContent.innerHTML = '';
                        updateDashboard();
                    } catch (error) {
                        console.error('Error processing Excel data:', error);
                        resultsContent.innerHTML = '<div class="no-results">Error loading transport data.</div>';
                    }
                };
                reader.readAsArrayBuffer(blob);
            } catch (error) {
                console.error('Error fetching transport data:', error);
                document.getElementById('resultsContent').innerHTML = '<div class="no-results">Error loading data.</div>';
            }
        }

        function processTransportData(jsonData, worksheet) {
            if (!jsonData || jsonData.length < 2) return;
            const headers = jsonData[0].map(h => h ? h.toString().trim() : '');
            transportData = [];
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (row && row.length > 0) {
                    const rowData = {};
                    headers.forEach((header, index) => {
                        if (header && row[index] !== undefined) {
                            rowData[header] = header === 'Accounting Date' && row[index]
                                ? convertExcelDate(row[index])
                                : row[index];
                        }
                    });
                    transportData.push(rowData);
                }
            }
        }

        function updateDashboard() {
            if (transportData.length === 0) {
                document.getElementById('totalVehicles').textContent = '0';
                document.getElementById('totalQuantity').textContent = '0.00';
                document.getElementById('totalAmount').textContent = '₹0.00';
                return;
            }
            let totalVehicles = new Set();
            let totalQuantity = 0;
            let totalAmount = 0;
            let productBreakdown = {};
            let vehicleBreakdown = {};
            transportData.forEach(record => {
                const vehicleNo = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                if (vehicleNo) {
                    totalVehicles.add(vehicleNo);
                    if (!vehicleBreakdown[vehicleNo]) vehicleBreakdown[vehicleNo] = { quantity: 0, amount: 0 };
                }
                let quantity = 0;
                const netWt = record['NET WT'];
                if (netWt !== undefined && netWt !== null && netWt !== '') {
                    quantity = parseFloat(netWt.toString().trim()) || 0;
                }
                totalQuantity += quantity;
                let amount = 0;
                const transportAmount = record['Transport Amount'];
                if (transportAmount !== undefined && transportAmount !== null && transportAmount !== '') {
                    amount = parseFloat(transportAmount.toString().trim()) || 0;
                }
                totalAmount += amount;
                const product = record['Material'] || 'Unknown';
                if (!productBreakdown[product]) productBreakdown[product] = { quantity: 0, amount: 0 };
                productBreakdown[product].quantity += quantity;
                productBreakdown[product].amount += amount;
                if (vehicleNo && vehicleBreakdown[vehicleNo]) {
                    vehicleBreakdown[vehicleNo].quantity += quantity;
                    vehicleBreakdown[vehicleNo].amount += amount;
                }
            });
            document.getElementById('totalVehicles').textContent = totalVehicles.size;
            document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
            const productBreakdownElement = document.getElementById('productBreakdown');
            productBreakdownElement.innerHTML = '';
            const sortedProducts = Object.entries(productBreakdown).sort((a, b) => b[1].quantity - a[1].quantity);
            sortedProducts.forEach(([product, data]) => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `<div class="product-name">${product}</div><div class="product-qty">${data.quantity.toFixed(2)}</div><div class="product-amount">₹${data.amount.toFixed(2)}</div>`;
                productBreakdownElement.appendChild(item);
            });
            const topVehiclesElement = document.getElementById('topVehicles');
            topVehiclesElement.innerHTML = '';
            const sortedVehicles = Object.entries(vehicleBreakdown).sort((a, b) => b[1].amount - a[1].amount).slice(0, 5);
            sortedVehicles.forEach(([vehicle, data]) => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `<div class="product-name">${vehicle}</div><div class="product-qty">${data.quantity.toFixed(2)}</div><div class="product-amount">₹${data.amount.toFixed(2)}</div>`;
                topVehiclesElement.appendChild(item);
            });
        }

        function convertExcelDate(excelDate) {
            if (typeof excelDate === 'string' && excelDate.includes('-')) return excelDate;
            if (typeof excelDate === 'number') {
                const jsDate = new Date(new Date(1900, 0, 1).getTime() + (excelDate - 2) * 86400000);
                return jsDate.toISOString().split('T')[0];
            }
            if (excelDate instanceof Date) return excelDate.toISOString().split('T')[0];
            return excelDate;
        }

        function formatDateForDisplay(dateValue) {
            if (!dateValue) return '';
            if (typeof dateValue === 'string' && dateValue.includes('-')) {
                const date = new Date(dateValue);
                return !isNaN(date.getTime()) ? date.toLocaleDateString('en-IN') : dateValue;
            }
            if (dateValue instanceof Date) return dateValue.toLocaleDateString('en-IN');
            return dateValue;
        }

        function setupSearchFunctionality() {
            const searchInput = document.getElementById('vehicleSearch');
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.trim().toUpperCase();
                if (searchTerm.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }
                const matches = getMatchingVehicles(searchTerm);
                displaySuggestions(matches, searchTerm);
            });
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.style.display = 'none';
                }
            });
            searchInput.addEventListener('keydown', function(e) {
                const suggestions = suggestionsContainer.querySelectorAll('.suggestion-item');
                const activeSuggestion = suggestionsContainer.querySelector('.suggestion-item.active');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (suggestions.length > 0) {
                        if (!activeSuggestion) {
                            suggestions[0].classList.add('active');
                        } else {
                            const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                            const nextIndex = (currentIndex + 1) % suggestions.length;
                            activeSuggestion.classList.remove('active');
                            suggestions[nextIndex].classList.add('active');
                        }
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (suggestions.length > 0 && activeSuggestion) {
                        const currentIndex = Array.from(suggestions).indexOf(activeSuggestion);
                        const prevIndex = (currentIndex - 1 + suggestions.length) % suggestions.length;
                        activeSuggestion.classList.remove('active');
                        suggestions[prevIndex].classList.add('active');
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (activeSuggestion) {
                        searchInput.value = activeSuggestion.textContent;
                        suggestionsContainer.style.display = 'none';
                        searchVehicle();
                    } else {
                        searchVehicle();
                    }
                }
            });
        }

        function getMatchingVehicles(searchTerm) {
            const matches = [];
            vehicleData.forEach(vehicle => {
                vehicle.vehicleNumbers.forEach(number => {
                    if (number && number.includes(searchTerm) && !matches.includes(number)) {
                        matches.push(number);
                    }
                });
            });
            if (transportData.length > 0) {
                transportData.forEach(record => {
                    const vehicleNo = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                    if (vehicleNo && vehicleNo.includes(searchTerm) && !matches.includes(vehicleNo)) {
                        matches.push(vehicleNo);
                    }
                });
            }
            matches.sort((a, b) => a.indexOf(searchTerm) - b.indexOf(searchTerm));
            return matches;
        }

        function displaySuggestions(matches, searchTerm) {
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            suggestionsContainer.innerHTML = '';
            if (matches.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            matches.forEach(match => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = match.replace(new RegExp(searchTerm, 'gi'), '<span class="highlight">$&</span>');
                item.addEventListener('click', () => {
                    document.getElementById('vehicleSearch').value = match;
                    suggestionsContainer.style.display = 'none';
                    searchVehicle();
                });
                item.addEventListener('mouseover', () => {
                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                });
                suggestionsContainer.appendChild(item);
            });
            suggestionsContainer.style.display = 'block';
        }

        function searchVehicle() {
            const searchValue = document.getElementById('vehicleSearch').value.trim().toUpperCase();
            if (!searchValue) {
                alert('Please enter a vehicle number');
                return;
            }
            const results = vehicleData.filter(vehicle => vehicle.vehicleNumbers.includes(searchValue));
            displayResults(results, searchValue);
        }

        function displayResults(results, searchValue) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            resultsContent.innerHTML = '';
            window.currentSearch = {
                vehicleNumber: searchValue,
                vendorDetails: results,
                transportRecords: [],
                allVendorVehicles: [],
                vendorTotals: { totalVehicles: 0, totalRecords: 0, totalQuantity: 0, totalAmount: 0 },
                manualAmount: null
            };
            const transportRecords = transportData.filter(record => {
                const v = record['VEHICLE NO'] ? record['VEHICLE NO'].toString().trim().toUpperCase() : '';
                return v === searchValue;
            });
            window.currentSearch.transportRecords = transportRecords;
            if (results.length === 0) {
                if (transportRecords.length > 0) {
                    resultsContent.innerHTML += '<div class="warning"><strong>Note:</strong> Vendor details not found, but transport records exist.</div>';
                    displayTransportDetails(searchValue, transportRecords);
                } else {
                    resultsContent.innerHTML = '<div class="no-results">No data found.</div>';
                }
            } else {
                const vendorGroups = {};
                results.forEach(vehicle => {
                    const key = vehicle.partyName + '|' + vehicle.pan;
                    if (!vendorGroups[key]) vendorGroups[key] = { vendor: vehicle, vehicles: [] };
                    vehicle.vehicleNumbers.forEach(v => {
                        if (!vendorGroups[key].vehicles.includes(v)) vendorGroups[key].vehicles.push(v);
                    });
                });
                window.currentSearch.allVendorVehicles = Object.values(vendorGroups).flatMap(g => g.vehicles);
                Object.values(vendorGroups).forEach((group, index) => {
                    const vendorGroupDiv = document.createElement('div');
                    vendorGroupDiv.className = 'vendor-group';
                    const header = document.createElement('div');
                    header.className = 'vendor-header';
                    header.innerHTML = `<div><div class="result-title">${group.vendor.partyName}</div><div><strong>PAN:</strong> ${group.vendor.pan}</div></div><div>${group.vehicles.length} Vehicles</div>`;
                    header.addEventListener('click', () => {
                        document.getElementById(`vendorVehicles${index}`).classList.toggle('expanded');
                    });
                    vendorGroupDiv.appendChild(header);
                    const vehiclesDiv = document.createElement('div');
                    vehiclesDiv.className = 'vendor-vehicles';
                    vehiclesDiv.id = `vendorVehicles${index}`;
                    group.vehicles.forEach(v => {
                        const opt = document.createElement('div');
                        opt.className = 'vehicle-option';
                        if (v === searchValue) opt.classList.add('selected');
                        opt.textContent = v;
                        opt.addEventListener('click', () => {
                            document.querySelectorAll(`#vendorVehicles${index} .vehicle-option`).forEach(o => o.classList.remove('selected'));
                            opt.classList.add('selected');
                            document.getElementById('vehicleSearch').value = v;
                            searchVehicle();
                        });
                        vehiclesDiv.appendChild(opt);
                    });
                    vendorGroupDiv.appendChild(vehiclesDiv);
                    resultsContent.appendChild(vendorGroupDiv);
                    const details = document.createElement('div');
                    details.className = 'result-item';
                    details.innerHTML = `<div><strong>Bank A/c:</strong> ${group.vendor.accountNo}</div><div><strong>Bank:</strong> ${group.vendor.bankName}</div><div><strong>Beneficiary:</strong> ${group.vendor.beneficiary}</div>`;
                    resultsContent.appendChild(details);
                    displayVendorTransportDetails(group.vendor, group.vehicles);
                });
            }
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayVendorTransportDetails(vendor, vehicleNumbers) {
            const allRecords = [];
            let totalQty = 0, totalAmt = 0, totalRecs = 0;
            vehicleNumbers.forEach(vNo => {
                const recs = transportData.filter(r => (r['VEHICLE NO'] || '').toString().trim().toUpperCase() === vNo);
                allRecords.push(...recs);
                recs.forEach(r => {
                    totalQty += parseFloat(r['NET WT']) || 0;
                    totalAmt += parseFloat(r['Transport Amount']) || 0;
                    totalRecs++;
                });
            });
            window.currentSearch.vendorTotals = {
                totalVehicles: vehicleNumbers.length,
                totalRecords: totalRecs,
                totalQuantity: totalQty,
                totalAmount: totalAmt
            };
            const summary = document.createElement('div');
            summary.className = 'vendor-total-summary';
            summary.innerHTML = `
                <div class="vendor-total-title">Vendor Total Summary</div>
                <div class="vendor-total-details">
                    <div class="vendor-total-item"><div class="vendor-total-label">Vehicles</div><div class="vendor-total-value">${vehicleNumbers.length}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Records</div><div class="vendor-total-value">${totalRecs}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Quantity</div><div class="vendor-total-value">${totalQty.toFixed(2)}</div></div>
                    <div class="vendor-total-item"><div class="vendor-total-label">Amount</div><div class="vendor-total-value">₹${totalAmt.toFixed(2)}</div></div>
                </div>
            `;
            document.getElementById('resultsContent').appendChild(summary);
            vehicleNumbers.forEach(vNo => {
                const recs = allRecords.filter(r => (r['VEHICLE NO'] || '').toString().trim().toUpperCase() === vNo);
                if (recs.length > 0) displayTransportDetails(vNo, recs);
            });
        }

        function displayTransportDetails(vehicleNumber, transportRecords) {
            if (transportRecords.length === 0) return;
            const div = document.createElement('div');
            div.className = 'transport-details';
            div.innerHTML = `
                <div class="result-title">Transport Details for Vehicle: ${vehicleNumber}</div>
                <table class="transport-table">
                    <thead><tr><th>Date</th><th>Customer</th><th>Vehicle</th><th>Material</th><th>Net Wt</th><th>Rate</th><th>Amount</th></tr></thead>
                    <tbody id="tbody_${vehicleNumber.replace(/\s+/g, '_')}"></tbody>
                </table>
                <div class="summary-box" id="summary_${vehicleNumber.replace(/\s+/g, '_')}">
                    <div class="summary-item"><div class="summary-label">Records</div><div class="summary-value" id="recs_${vehicleNumber.replace(/\s+/g, '_')}">0</div></div>
                    <div class="summary-divider"></div>
                    <div class="summary-item"><div class="summary-label">Quantity</div><div class="summary-value" id="qty_${vehicleNumber.replace(/\s+/g, '_')}">0</div></div>
                    <div class="summary-divider"></div>
                    <div class="summary-item"><div class="summary-label">Amount</div><div class="summary-value" id="amt_${vehicleNumber.replace(/\s+/g, '_')}">0.00</div></div>
                </div>
                <div class="amount-edit">
                    <label for="manual_${vehicleNumber.replace(/\s+/g, '_')}">Manual Amount:</label>
                    <input type="number" id="manual_${vehicleNumber.replace(/\s+/g, '_')}" class="amount-input" placeholder="Enter amount">
                    <button type="button" class="btn-update" onclick="updateTotalAmount('${vehicleNumber}')">Update</button>
                </div>
            `;
            document.getElementById('resultsContent').appendChild(div);
            const tbody = document.getElementById(`tbody_${vehicleNumber.replace(/\s+/g, '_')}`);
            let totalQty = 0, totalAmt = 0;
            transportRecords.forEach(r => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDateForDisplay(r['Accounting Date'])}</td>
                    <td>${r['NAME OF THE CUSTOMER'] || ''}</td>
                    <td>${r['VEHICLE NO'] || ''}</td>
                    <td>${r['Material'] || ''}</td>
                    <td>${r['NET WT'] || ''}</td>
                    <td>${r['Transport Rate'] || ''}</td>
                    <td>${r['Transport Amount'] || ''}</td>
                `;
                tbody.appendChild(row);
                totalQty += parseFloat(r['NET WT']) || 0;
                totalAmt += parseFloat(r['Transport Amount']) || 0;
            });
            document.getElementById(`recs_${vehicleNumber.replace(/\s+/g, '_')}`).textContent = transportRecords.length;
            document.getElementById(`qty_${vehicleNumber.replace(/\s+/g, '_')}`).textContent = totalQty.toFixed(2);
            document.getElementById(`amt_${vehicleNumber.replace(/\s+/g, '_')}`).textContent = totalAmt.toFixed(2);
            document.getElementById(`manual_${vehicleNumber.replace(/\s+/g, '_')}`).value = totalAmt.toFixed(2);
        }

        function updateTotalAmount(vehicleNumber) {
            const inputId = `manual_${vehicleNumber.replace(/\s+/g, '_')}`;
            const manual = parseFloat(document.getElementById(inputId).value);
            if (isNaN(manual)) {
                alert('Enter valid amount');
                return;
            }
            document.getElementById(`amt_${vehicleNumber.replace(/\s+/g, '_')}`).textContent = manual.toFixed(2);
            if (window.currentSearch) window.currentSearch.manualAmount = manual;
            alert('Amount updated!');
        }

        function saveCurrentResult() {
            if (!window.currentSearch) {
                alert('No search results to save');
                return;
            }
            const vendor = window.currentSearch.vendorDetails.length > 0
                ? window.currentSearch.vendorDetails[0] : null;
            const allVehicles = window.currentSearch.allVendorVehicles || [];
            const key = getVendorKey(vendor) || window.currentSearch.vehicleNumber;
            const allRecords = [];
            let totalQty = 0, totalAmt = 0, totalRecs = 0;
            allVehicles.forEach(vNo => {
                const recs = transportData.filter(r =>
                    (r['VEHICLE NO'] || '').toString().trim().toUpperCase() === vNo);
                recs.forEach(r => {
                    const qty = parseFloat(r['NET WT']) || 0;
                    const amt = parseFloat(r['Transport Amount']) || 0;
                    totalQty += qty;
                    totalAmt += amt;
                    totalRecs++;
                });
                allRecords.push(...recs);
            });
            const manualAmt = window.currentSearch.manualAmount || 0;
            const finalAmount = manualAmt > 0 ? manualAmt : totalAmt;
            const saveObj = {
                vehicleNumber: window.currentSearch.vehicleNumber,
                vendorDetails: vendor ? [vendor] : [],
                allVendorVehicles: allVehicles,
                allVendorTransportRecords: allRecords,
                vendorTotals: {
                    totalVehicles: allVehicles.length,
                    totalRecords: totalRecs,
                    totalQuantity: totalQty,
                    totalAmount: finalAmount
                },
                timestamp: new Date().toISOString()
            };
            const existingIdx = savedResults.findIndex(r => {
                const rk = getVendorKey(r.vendorDetails[0]) || r.vehicleNumber;
                return rk === key;
            });
            if (existingIdx > -1) {
                if (manualAmt > 0) savedResults[existingIdx].vendorTotals.totalAmount = manualAmt;
                Object.assign(savedResults[existingIdx], saveObj);
            } else {
                savedResults.push(saveObj);
            }
            saveSavedResults();
            displaySavedResults();
            alert('Result saved successfully!');
        }

        function loadSavedResults() {
            const saved = localStorage.getItem('transportSavedResults');
            if (saved) {
                savedResults = JSON.parse(saved);
                displaySavedResults();
            }
        }

        function saveSavedResults() {
            localStorage.setItem('transportSavedResults', JSON.stringify(savedResults));
        }

        function displaySavedResults() {
            const list = document.getElementById('savedResultsList');
            if (savedResults.length === 0) {
                list.innerHTML = '<div class="no-results">No saved results. Search and save.</div>';
                return;
            }
            list.innerHTML = '';
            savedResults.forEach((result, i) => {
                const item = document.createElement('div');
                item.className = 'saved-result-item';
                const vendor = result.vendorDetails.length > 0 ? result.vendorDetails[0] : null;
                const totals = result.vendorTotals;
                item.innerHTML = `
                    <div class="saved-result-info">
                        <div class="result-title">${vendor ? vendor.partyName : 'No Vendor'}</div>
                        <div><strong>PAN:</strong> ${vendor ? vendor.pan : 'N/A'}</div>
                        <div><strong>Vehicles:</strong> ${totals.totalVehicles}</div>
                        <div><strong>Records:</strong> ${totals.totalRecords}</div>
                        <div><strong>Qty:</strong> ${totals.totalQuantity.toFixed(2)}</div>
                        <div><strong>Amount:</strong> ₹${totals.totalAmount.toFixed(2)}</div>
                    </div>
                    <div class="saved-result-actions">
                        <button type="button" class="btn-view" onclick="viewSavedResult(${i})">View</button>
                        <button type="button" class="btn-remove" onclick="removeSavedResult(${i})">Remove</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function viewSavedResult(index) {
            if (index < 0 || index >= savedResults.length) return;
            const result = savedResults[index];
            const firstVehicle = result.allVendorVehicles && result.allVendorVehicles.length > 0 ? result.allVendorVehicles[0] : result.vehicleNumber;
            document.getElementById('vehicleSearch').value = firstVehicle;
            displayResults(result.vendorDetails, firstVehicle);
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function removeSavedResult(index) {
            if (confirm('Remove this saved result?')) {
                savedResults.splice(index, 1);
                saveSavedResults();
                displaySavedResults();
            }
        }

        function clearSavedResults() {
            if (savedResults.length === 0) return alert('No results to clear');
            if (confirm('Clear all saved results?')) {
                savedResults = [];
                saveSavedResults();
                displaySavedResults();
            }
        }

        // FIXED: downloadSavedResults() – waits for XLSX and uses safe sheet names
        function downloadSavedResults() {
            if (typeof XLSX === 'undefined') {
                alert('Excel library is still loading… please try again in a second.');
                return;
            }
            if (savedResults.length === 0) {
                alert('No saved results to export.');
                return;
            }

            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const summary = [
                ['Vendor', 'PAN', 'A/c No', 'Bank', 'Beneficiary', 'Vehicles', 'Records', 'Qty', 'Amount']
            ];
            savedResults.forEach(r => {
                const v = r.vendorDetails.length > 0 ? r.vendorDetails[0] : null;
                const t = r.vendorTotals;
                summary.push([
                    v ? v.partyName : 'N/A',
                    v ? v.pan : 'N/A',
                    v ? v.accountNo : 'N/A',
                    v ? v.bankName : 'N/A',
                    v ? v.beneficiary : 'N/A',
                    t.totalVehicles,
                    t.totalRecords,
                    t.totalQuantity,
                    t.totalAmount
                ]);
            });
            const wsSummary = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

            // One sheet per vendor
            savedResults.forEach((r, i) => {
                const v = r.vendorDetails.length > 0 ? r.vendorDetails[0] : null;
                const safeName = (v ? v.partyName : `Vendor_${i+1}`)
                    .replace(/[^\w]/g, '_')
                    .substring(0, 31);

                const data = [
                    ['Date', 'Customer', 'Vehicle', 'Material', 'Net Wt', 'Rate', 'Amount']
                ];
                r.allVendorTransportRecords.forEach(rec => {
                    data.push([
                        formatDateForDisplay(rec['Accounting Date']),
                        rec['NAME OF THE CUSTOMER'] || '',
                        rec['VEHICLE NO'] || '',
                        rec['Material'] || '',
                        rec['NET WT'] || '',
                        rec['Transport Rate'] || '',
                        rec['Transport Amount'] || ''
                    ]);
                });
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, safeName);
            });

            const fileName = `Transport_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function printResults() { window.print(); }

        function toggleAddVendorForm() {
            const section = document.getElementById('addVendorSection');
            const results = document.getElementById('resultsSection');
            if (section.style.display === 'block') {
                section.style.display = 'none';
                document.getElementById('vendorForm').reset();
                const container = document.getElementById('vehicleNumbersContainer');
                while (container.children.length > 1) container.removeChild(container.lastChild);
            } else {
                section.style.display = 'block';
                results.style.display = 'none';
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function addVehicleField() {
            const container = document.getElementById('vehicleNumbersContainer');
            const div = document.createElement('div');
            div.className = 'vehicle-number-input';
            div.innerHTML = `<input type="text" class="vehicleNumber" placeholder="Vehicle Number"><button type="button" class="remove-vehicle" onclick="removeVehicleField(this)">Remove</button>`;
            container.appendChild(div);
        }

        function removeVehicleField(btn) {
            const container = document.getElementById('vehicleNumbersContainer');
            if (container.children.length > 1) container.removeChild(btn.parentNode);
        }

        function addNewVendor() {
            const party = document.getElementById('partyName').value.trim();
            const acc = document.getElementById('accountNo').value.trim();
            const bank = document.getElementById('bankName').value.trim();
            const ben = document.getElementById('beneficiary').value.trim();
            const pan = document.getElementById('pan').value.trim();
            const inputs = document.querySelectorAll('.vehicleNumber');
            const vehicles = Array.from(inputs).map(i => i.value.trim().toUpperCase()).filter(v => v);
            if (!party || !acc || !bank || !ben || !pan || vehicles.length === 0) return alert('Fill all fields');
            vehicleData.push({ partyName: party, accountNo: acc, bankName: bank, beneficiary: ben, pan, vehicleNumbers: vehicles });
            alert('Vendor added!');
            document.getElementById('vendorForm').reset();
            toggleAddVendorForm();
        }

        window.onload = initApp;
    </script>
</body>
</html>
